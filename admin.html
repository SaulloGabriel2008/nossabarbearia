<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin | FLOW BARBER</title>
    <link rel="manifest" href="/manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #1e90ff; 
            --primary-hover: #1c86ee;
            --bg-dark: #0f0f0f;
            --bg-card: #1a1a1a;
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --border: #333333;
            --success: #10b981;
            --danger: #ef4444;
            --warn: #f59e0b;
            --accent: #3b82f6;
            --subscription: #8b5cf6;
            --subscription-light: rgba(139, 92, 246, 0.1);
            --subscription-border: rgba(139, 92, 246, 0.3);
            --whatsapp: #25d366;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); line-height: 1.5; font-size: 14px; }
        html, body { height: 100%; overflow-y: auto; overflow-x: hidden; }

        /* Login - Mobile First */
        #login-screen { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }
        
        .login-card { 
            background: var(--bg-card); 
            padding: 1.5rem; 
            border-radius: 1rem; 
            width: 100%; 
            max-width: 400px; 
            border: 1px solid var(--border);
        }

        /* Layout Principal */
        #admin-panel { 
            display: none; 
            min-height: 100vh;
            position: relative;
            overflow-y: auto;
        }
        
        /* Header com menu hamb√∫rguer */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .menu-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
        }
        
        /* Indicador da aba atual (baixo do logo) */
        .header-title #current-tab {
            margin-top: 5px;
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 700;
            display: block;
            opacity: 0.95;
        }
        
        .logo {
            color: var(--primary);
            font-weight: 900;
            font-size: 1.3rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Modal de navega√ß√£o */
        .nav-modal {
            display: none;
            position: fixed;
            top: 70px;
            left: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow: hidden;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .nav-modal.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .nav-modal-content {
            padding: 1rem 0;
        }
        
        .nav-modal-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
            border-left: 3px solid transparent;
            font-size: 0.95rem;
        }
        
        .nav-modal-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary);
            border-left-color: var(--primary);
        }
        
        .nav-modal-item.active {
            color: var(--primary);
            background: rgba(30, 144, 255, 0.1);
            border-left-color: var(--primary);
        }
        
        .nav-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
        }
        
        .nav-modal-overlay.active {
            display: block;
        }

        main { 
            padding: 1.5rem; 
            width: 100%; 
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Estilos para a vis√£o simplificada */
        .simple-dashboard {
            margin-bottom: 2rem;
        }

        .simple-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .simple-stat-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 1rem;
            border: 2px solid var(--border);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .simple-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .simple-stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-color: var(--primary);
        }

        .simple-stat-card:hover::before {
            left: 100%;
        }

        .simple-stat-card.primary {
            border-left: 4px solid var(--primary);
            box-shadow: -4px 0 20px rgba(30, 144, 255, 0.2);
        }

        .simple-stat-card.primary:hover {
            box-shadow: -4px 0 30px rgba(30, 144, 255, 0.4), 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .simple-stat-card.success {
            border-left: 4px solid var(--success);
            box-shadow: -4px 0 20px rgba(16, 185, 129, 0.2);
        }

        .simple-stat-card.success:hover {
            box-shadow: -4px 0 30px rgba(16, 185, 129, 0.4), 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .simple-stat-card.accent {
            border-left: 4px solid var(--accent);
            box-shadow: -4px 0 20px rgba(59, 130, 246, 0.2);
        }

        .simple-stat-card.accent:hover {
            box-shadow: -4px 0 30px rgba(59, 130, 246, 0.4), 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .simple-stat-card.subscription {
            border-left: 4px solid var(--subscription);
            box-shadow: -4px 0 20px rgba(139, 92, 246, 0.2);
        }

        .simple-stat-card.subscription:hover {
            box-shadow: -4px 0 30px rgba(139, 92, 246, 0.4), 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .simple-stat-icon {
            background: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(139, 92, 246, 0.1));
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .simple-stat-card:hover .simple-stat-icon {
            background: linear-gradient(135deg, rgba(30, 144, 255, 0.3), rgba(139, 92, 246, 0.2));
            transform: scale(1.1) rotate(5deg);
        }

        .simple-stat-icon i {
            width: 28px;
            height: 28px;
        }

        .simple-stat-content {
            flex: 1;
        }

        .simple-stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .simple-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 4px;
        }

        .simple-stat-period {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .simple-upcoming-clients {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 144, 255, 0.05) 100%);
            border-radius: 1rem;
            border: 2px solid var(--border);
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .simple-upcoming-clients:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(30, 144, 255, 0.15);
        }

        .simple-upcoming-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }

        .simple-upcoming-header h4 {
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 700;
        }

        .simple-upcoming-header i {
            color: var(--primary);
            width: 24px;
            height: 24px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .simple-upcoming-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .upcoming-client-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(30, 144, 255, 0.05));
            border-radius: 10px;
            border: 1px solid rgba(30, 144, 255, 0.2);
            transition: all 0.3s ease;
        }

        .upcoming-client-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(30, 144, 255, 0.1));
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(30, 144, 255, 0.2);
            transform: translateX(4px);
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-weight: 600;
            color: var(--text-main);
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .client-service {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .client-time {
            font-size: 0.8rem;
            color: var(--primary);
            font-weight: 500;
        }

        .client-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .client-status.confirmed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1));
            color: var(--success);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .client-status.subscriber {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.1));
            color: #8b5cf6;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
        }

        .client-status.completed {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.3), rgba(107, 114, 128, 0.1));
            color: var(--text-muted);
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        .no-upcoming {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .simple-upcoming-clients {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .simple-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .simple-upcoming-clients {
                grid-column: span 1;
            }
            
            .simple-stat-value {
                font-size: 1.5rem;
            }
        }

        /* Stats */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1rem; 
            margin-bottom: 2rem; 
        }
        
        .stat-card { 
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 144, 255, 0.05) 100%);
            padding: 1.5rem; 
            border-radius: 1rem; 
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.15);
            transform: translateY(-4px);
        }
        
        .stat-value { 
            font-size: 1.8rem; 
            font-weight: 700; 
            color: var(--text-main); 
            margin-top: 0.5rem; 
        }

        /* Agenda */
        .calendar-wrapper { 
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem; 
            align-items: start; 
        }
        
        .calendar-card { 
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 144, 255, 0.05) 100%);
            border-radius: 1rem; 
            border: 2px solid var(--border);
            overflow: hidden; 
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .calendar-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.15);
        }
        
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem 1.5rem; 
            background: #111111; 
        }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background: var(--border); 
        }
        
        .calendar-day { 
            background: var(--bg-card); 
            min-height: 80px; 
            padding: 0.5rem; 
            cursor: pointer; 
            transition: 0.2s; 
            position: relative; 
            font-size: 0.9rem;
        }
        
        .calendar-day:hover { background: #222222; }
        .calendar-day.selected { border: 2px solid var(--primary); z-index: 10; }
        .calendar-day.closed { opacity: 0.4; background: #0a0a0a; }
        .day-number { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        
        .slots-container { 
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 144, 255, 0.05) 100%);
            border-radius: 1rem; 
            border: 2px solid var(--border);
            padding: 1.5rem; 
            width: 100%;
            height: fit-content;
            position: sticky;
            top: 90px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .slots-container:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.15);
        }
        
        .slots-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 10px; 
            margin-top: 1.5rem; 
        }
        
        .slot-btn { 
            padding: 12px; 
            border: 1px solid var(--border); 
            background: #111111; 
            color: white; 
            border-radius: 8px; 
            cursor: pointer; 
            text-align: center; 
            font-size: 0.9rem; 
            transition: 0.2s;
            position: relative;
        }
        
        .slot-btn.occupied { border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .slot-btn.blocked { background: #2a1010; color: var(--danger); border-color: var(--danger); opacity: 0.7; }
        .slot-btn.part-of-long { border-style: dashed; opacity: 0.9; }
        
        .slot-btn.active-editing {
            border: 2px solid var(--primary);
            box-shadow: 0 0 10px rgba(30, 144, 255, 0.4);
            transform: translateY(-2px);
        }

        /* Form Estilizado */
        .admin-section { 
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 144, 255, 0.05) 100%);
            padding: 1.5rem; 
            border-radius: 1rem; 
            border: 2px solid var(--border);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .admin-section:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.15);
        }
        
        .form-row { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; 
            margin-bottom: 1.5rem; 
        }
        
        input, select, textarea { 
            background: linear-gradient(135deg, #111111, rgba(30, 144, 255, 0.05));
            border: 2px solid var(--border); 
            padding: 0.75rem; 
            color: white; 
            border-radius: 0.5rem; 
            width: 100%; 
            outline: none; 
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(30, 144, 255, 0.2);
            background: linear-gradient(135deg, #0a0a0a, rgba(30, 144, 255, 0.08));
        }
        
        label { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            margin-bottom: 0.5rem; 
            display: block; 
        }
        
        .btn-action { 
            background: linear-gradient(135deg, var(--primary), rgba(30, 144, 255, 0.8));
            color: white; 
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px; 
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.3);
        }
        
        .btn-action:hover { 
            background: linear-gradient(135deg, var(--primary-hover), rgba(28, 134, 238, 0.9));
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 144, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .btn-whatsapp { 
            background: var(--whatsapp); 
            color: white; 
            border: none; 
            width: 36px; 
            height: 36px; 
            border-radius: 0.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        
        .btn-whatsapp:hover { opacity: 0.8; }

        /* Tabelas */
        .table-wrapper { 
            width: 100%; 
            overflow-x: auto; 
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 144, 255, 0.05) 100%);
            border-radius: 1rem; 
            border: 2px solid var(--border);
            -webkit-overflow-scrolling: touch;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .table-wrapper:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.15);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            text-align: left; 
        }
        
        th { 
            padding: 1rem; 
            background: #111111; 
            color: var(--text-muted); 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        
        td { 
            padding: 1rem; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.9rem; 
        }
        
        tr:last-child td { border: none; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .charts-container { 
            display: grid; 
            grid-template-columns: 1.5fr 1fr;
            gap: 1.5rem; 
            margin-top: 2rem; 
        }
        
        .chart-box {
            position: relative;
            height: 300px;
            width: 100%;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 144, 255, 0.05) 100%);
            border-radius: 1rem;
            border: 2px solid var(--border);
            padding: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .chart-box:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.15);
        }

        /* Toggle de Servi√ßos */
        .autismo-toggle { 
            display: flex; 
            gap: 8px; 
            margin-top: 5px; 
        }
        
        .toggle-btn { 
            flex: 1; 
            padding: 10px; 
            border: 1px solid var(--border); 
            background: #111111; 
            color: var(--text-muted); 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 0.9rem; 
            text-align: center; 
        }
        
        .toggle-btn.active-yes { background: var(--success); color: white; border-color: var(--success); }
        .toggle-btn.active-no { background: var(--danger); color: white; border-color: var(--danger); }
        .toggle-btn.active-primary { background: var(--primary); color: white; border-color: var(--primary); }

        /* Estilo Financeiro Toggle */
        .finance-toggle { 
            display: flex; 
            margin-bottom: 1.5rem; 
            background: var(--border); 
            padding: 4px; 
            border-radius: 0.75rem; 
            width: 100%; 
        }
        
        .finance-toggle button { 
            background: none; 
            border: none; 
            padding: 0.75rem 1rem; 
            color: var(--text-muted); 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 600; 
            transition: 0.2s; 
            flex: 1;
            font-size: 0.85rem;
        }
        
        .finance-toggle button.active { 
            background: var(--bg-card); 
            color: var(--primary); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
        }

        /* Estilo Lan√ßamento R√°pido */
        .quick-launch-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .btn-quick { 
            padding: 15px; 
            border-radius: 8px; 
            border: none; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px; 
            font-size: 0.8rem;
        }
        
        .btn-quick:hover { transform: translateY(-2px); }

        /* Status Badge */
        .status-badge { 
            padding: 5px 10px; 
            border-radius: 10px; 
            font-size: 0.75rem; 
            font-weight: bold; 
            text-transform: uppercase; 
            display: inline-block;
        }
        
        .status-pago { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-pendente { background: rgba(245, 158, 11, 0.2); color: var(--warn); }
        
        /* Bot√µes de a√ß√£o em linha */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn-action {
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        /* Ajustes para mobile */
        @media (max-width: 768px) {
            .calendar-wrapper {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-modal {
                left: 1rem;
                right: 1rem;
                top: 60px;
            }
            
            .main-header {
                padding: 0.75rem 1rem;
            }
            
            main {
                padding: 1rem;
            }
            
            .slots-container {
                position: static;
            }
        }
        
        /* Bot√£o voltar ao topo */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), rgba(30, 144, 255, 0.8));
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000; /* Mais alto para garantir que fique vis√≠vel */
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.3);
            font-size: 1.2rem;
        }
        
        .back-to-top:hover {
            opacity: 1;
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 12px 35px rgba(30, 144, 255, 0.5);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        /* Scroll suave */
        html {
            scroll-behavior: smooth;
        }
        
        /* Estilo para toast/notifica√ß√µes */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
            max-width: 90%;
            text-align: center;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .toast.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Estilos para Assinaturas no Admin */
        .subscription-indicator {
            background: var(--subscription);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .calendar-day.subscription {
            border: 2px solid var(--subscription);
            background: var(--subscription-light);
            position: relative;
        }
        .calendar-day.subscription::before {
            content: "üëë";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.8rem;
        }
        .subscription-client-card {
            background: var(--subscription-light);
            border: 1px solid var(--subscription-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .client-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--subscription);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .subscription-progress {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        .subscription-progress-bar {
            height: 100%;
            background: var(--subscription);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .subscription-alert {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warn);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            color: var(--warn);
            font-size: 0.9rem;
        }
        .subscription-usage-detail {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid var(--border);
        }
        .usage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .usage-item:last-child {
            border-bottom: none;
        }
        
        .period-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.2s;
        }
        
        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem;">FLOW BARBER</h2>
            <div style="margin-bottom: 1rem;"><label>Email</label><input type="email" id="login-email" autocomplete="email"></div>
            <div style="margin-bottom: 1.5rem;"><label>Senha</label><input type="password" id="login-password" autocomplete="current-password"></div>
            <button class="btn-action" id="btn-login" style="width: 100%;">ENTRAR</button>
            <p id="login-error" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px; text-align: center; display: none;"></p>
        </div>
    </div>

    <div id="admin-panel">
        <button id="btn-seed-users" style="display:none; margin: 10px; padding:8px 12px;">Seed: Criar Usu√°rios Iniciais</button>
        <header class="main-header">
            <button class="menu-btn" onclick="toggleNavModal()">
                <i data-lucide="menu"></i>
            </button>
            <div class="header-title">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span class="logo" onclick="switchTab('dashboard')" style="cursor: pointer;">FLOW BARBER</span>
                </div>
                <span id="current-tab">Dashboard</span>
            </div>
            <button class="btn-action" onclick="logout()" style="background: var(--danger); padding: 8px 16px; font-size: 0.85rem;">
                <i data-lucide="log-out"></i> SAIR
            </button>
        </header>
        
        <div class="nav-modal-overlay" onclick="toggleNavModal()"></div>
        <div class="nav-modal" id="nav-modal">
            <div class="nav-modal-content">
                <div class="nav-modal-item active" onclick="switchTab('dashboard');">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </div>
                <div class="nav-modal-item" onclick="switchTab('agendamentos');">
                    <i data-lucide="calendar"></i> Agenda
                </div>
                <div class="nav-modal-item" onclick="switchTab('clientes');">
                    <i data-lucide="users"></i> Clientes
                </div>
                <div class="nav-modal-item" id="assinaturas-menu-item" onclick="switchTab('assinaturas');">
                    <i data-lucide="credit-card"></i> Assinaturas
                </div>
                <div class="nav-modal-item" onclick="switchTab('finan√ßas');">
                    <i data-lucide="wallet"></i> Finan√ßas
                </div>
                <div class="nav-modal-item" id="configuracoes-menu-item" onclick="switchTab('configura√ß√µes');">
                    <i data-lucide="settings"></i> Configura√ß√µes
                </div>
            </div>
        </div>

        <main>
            <div id="tab-dashboard" class="tab-content active">
                <!-- VIS√ÉO SIMPLIFICADA -->
                <div class="simple-dashboard">
                    <div class="simple-stats-grid">
                        <div class="simple-stat-card primary">
                            <div class="simple-stat-icon">
                                <i data-lucide="dollar-sign"></i>
                            </div>
                            <div class="simple-stat-content">
                                <div class="simple-stat-label">Valor Arrecadado</div>
                                <div class="simple-stat-value" id="simple-month-revenue">R$ 0,00</div>
                                <div class="simple-stat-period">este m√™s</div>
                            </div>
                        </div>
                        
                        <div class="simple-stat-card success">
                            <div class="simple-stat-icon">
                                <i data-lucide="calendar"></i>
                            </div>
                            <div class="simple-stat-content">
                                <div class="simple-stat-label">Agendamentos</div>
                                <div class="simple-stat-value" id="simple-today-bookings">0</div>
                                <div class="simple-stat-period">A realizar</div>
                            </div>
                        </div>
                        
                        <div class="simple-stat-card accent">
                            <div class="simple-stat-icon">
                                <i data-lucide="users"></i>
                            </div>
                            <div class="simple-stat-content">
                                <div class="simple-stat-label">Assinantes</div>
                                <div class="simple-stat-value" id="simple-subscribers">0</div>
                                <div class="simple-stat-period">ativos</div>
                            </div>
                        </div>
                        
                        <div class="simple-stat-card subscription">
                            <div class="simple-stat-icon">
                                <i data-lucide="star"></i>
                            </div>
                            <div class="simple-stat-content">
                                <div class="simple-stat-label">Agendamentos por</div>
                                <div class="simple-stat-value" id="simple-subscription-bookings">0</div>
                                <div class="simple-stat-period">assinatura</div>
                            </div>
                        </div>
                        
                        <div class="simple-upcoming-clients">
                            <div class="simple-upcoming-header">
                                <i data-lucide="clock"></i>
                                <h4>Agendamentos Hoje</h4>
                            </div>
                            <div class="simple-upcoming-list" id="simple-upcoming-list">
                                <div class="no-upcoming">Nenhum agendamento hoje</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard existente continua aqui -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span style="color:var(--text-muted); font-size: 0.9rem;">Receita Bruta</span>
                        <div class="stat-value" id="dash-revenue" style="color: var(--primary)">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <span style="color:var(--text-muted); font-size: 0.9rem;">Despesas</span>
                        <div class="stat-value" id="dash-expense" style="color: var(--warn)">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <span style="color:var(--text-muted); font-size: 0.9rem;">Saldo</span>
                        <div class="stat-value" id="dash-profit" style="color: var(--success)">R$ 0,00</div>
                    </div>
                </div>
                <div class="period-indicator">
                    <button id="period-month" class="period-btn active">M√™s</button>
                    <button id="period-week" class="period-btn">Semana</button>
                    <button id="period-year" class="period-btn">Ano</button>
                </div>
                <div class="charts-container">
                    <div class="stat-card">
                        <div class="chart-box">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="chart-box">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-agendamentos" class="tab-content">
                <div class="calendar-wrapper">
                    <div class="calendar-card">
                        <div class="calendar-header">
                            <button class="btn-action" style="padding: 8px 12px; font-size: 0.9rem;" onclick="changeMonth(-1)">
                                <i data-lucide="chevron-left"></i>
                            </button>
                            <h3 id="calendar-month-year" style="font-size: 1rem;">...</h3>
                            <button class="btn-action" style="padding: 8px 12px; font-size: 0.9rem;" onclick="changeMonth(1)">
                                <i data-lucide="chevron-right"></i>
                            </button>
                        </div>
                        <div style="grid-template-columns: repeat(7, 1fr); text-align: center; background: #111111; padding: 12px 0; font-size: 0.75rem; color: var(--text-muted); font-weight: bold; display: grid;">
                            <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>SAB</div>
                        </div>
                        <div class="calendar-grid" id="calendar-body"></div>
                        
                        <div style="padding: 1.5rem; background: #111111; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-action" style="background: var(--danger); color: white; font-size: 0.9rem;" onclick="toggleDayStatus('closed')">FECHAR DIA</button>
                                <button class="btn-action" style="background: var(--success); color: white; font-size: 0.9rem;" onclick="toggleDayStatus('open')">ABRIR DIA</button>
                            </div>
                            <button class="btn-action" style="background: var(--primary); color: white; font-size: 0.9rem;" onclick="addExtraSlot()">+ HOR√ÅRIO EXTRA</button>
                        </div>
                    </div>

                    <div class="slots-container">
                        <h4 id="selected-date-label" style="font-size: 1.1rem; margin-bottom: 1rem;">Data</h4>
                        <div class="slots-grid" id="slots-grid"></div>
                        
                        <div id="slot-editor" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h5 id="editor-title" style="color: var(--primary); font-size: 1rem;">Hor√°rio</h5>
                                <button id="btn-whatsapp-client" class="btn-whatsapp" title="Enviar Mensagem no WhatsApp" style="display: none;">
                                    <i data-lucide="message-circle"></i>
                                </button>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div>
                                    <label>Nome do Cliente</label>
                                    <input type="text" id="edit-client" placeholder="Nome do Cliente">
                                </div>
                                <div>
                                    <label>Telem√≥vel (Opcional)</label>
                                    <input type="tel" id="edit-phone" placeholder="28999999999">
                                </div>
                                <div>
                                    <label>Servi√ßo</label>
<select id="edit-service">
    <!-- Os servi√ßos ser√£o carregados automaticamente via JavaScript -->
    <option value="" disabled selected>Carregando servi√ßos...</option>
</select>
                                </div>
                                <div id="cortesia-slots-container" style="display: none;">
                                    <label>Quantos hor√°rios para a Cortesia?</label>
                                    <div class="autismo-toggle">
                                        <button id="cortesia-1" class="toggle-btn" onclick="setCortesiaSlots(1)">1 Hor√°rio</button>
                                        <button id="cortesia-2" class="toggle-btn" onclick="setCortesiaSlots(2)">2 Hor√°rios</button>
                                    </div>
                                </div>
                                <div id="assinatura-container" style="display: none;">
                                    <label>√â por Assinatura?</label>
                                    <div class="autismo-toggle">
                                        <button id="assinatura-yes" class="toggle-btn" onclick="setAssinatura(true)">Sim</button>
                                        <button id="assinatura-no" class="toggle-btn" onclick="setAssinatura(false)">N√£o</button>
                                    </div>
                                </div>
                                <div id="subscription-details" style="display: none;"></div>
                                <div id="observations-container" style="display: block;">
                                    <label>Observa√ß√µes e Prefer√™ncias</label>
                                    <textarea id="edit-observations" placeholder="Prefer√™ncias, notas especiais, necessidades do cliente..." style="width:100%; height:80px; margin-top:8px; padding:12px; background:#111111; color:#fff; border:1px solid var(--border); border-radius:8px; font-size: 0.9rem;"></textarea>
                                </div>
                                <div id="warning-double" style="display:none; color: var(--danger); font-size: 0.8rem; font-weight: bold;">
                                    ‚ö†Ô∏è Este servi√ßo requer 2 hor√°rios seguidos.
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <button class="btn-action" onclick="saveBooking()">SALVAR</button>
                                    <button class="btn-action" style="background: #333; color: white;" onclick="toggleBlockSlot()">BLOQUEAR</button>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <button id="btn-complete-booking" style="background: var(--success); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: none;" onclick="completeBooking()">CONCLUIR</button>
                                    <button id="btn-cancel-booking" style="background: var(--danger); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: none;" onclick="cancelBooking()">CANCELAR</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-clientes" class="tab-content">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Contato</th>
                                <th>√öltima Visita</th>
                                <th>Total</th>
                                <th onclick="toggleClientSort()">Dias ‚¨ç</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="list-clients"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-finan√ßas" class="tab-content">
                <div class="finance-toggle">
                    <button id="toggle-despesas" class="active" onclick="switchFinanceMode('despesas')">DESPESAS</button>
                    <button id="toggle-entradas" onclick="switchFinanceMode('entradas')">ENTRADAS</button>
                    <button id="toggle-relatorios" onclick="switchFinanceMode('relatorios')">RELAT√ìRIOS</button>
                </div>

                <div class="admin-section" id="section-finance-form">
                    <h4 id="finance-form-title" style="margin-bottom: 1rem; font-size: 1.1rem;">Lan√ßar Nova Despesa</h4>
                    
                    <div id="quick-products-container" style="display: none;">
                        <div class="quick-launch-grid">
                            <button class="btn-quick" style="background: #e67e22;" onclick="quickAdd('Cremes / Pomadas')">
                                <i data-lucide="package"></i>CREME
                            </button>
                            <button class="btn-quick" style="background: #27ae60;" onclick="quickAdd('Chips / Snacks')">
                                <i data-lucide="cookie"></i>CHIPS
                            </button>
                            <button class="btn-quick" style="background: #2980b9;" onclick="quickAdd('Refrigerantes')">
                                <i data-lucide="cup-soda"></i>REFRI
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div><label>Descri√ß√£o</label><input type="text" id="exp-desc" placeholder="Ex: Energia"></div>
                        <div><label>Valor (R$)</label><input type="number" id="exp-val" step="0.01"></div>
                        <div><label>Data</label><input type="date" id="exp-date"></div>
                        <div id="recurrence-container">
                            <label>Recorr√™ncia</label>
                            <select id="exp-recurrence">
                                <option value="">Nenhuma</option>
                                <option value="weekly">Semanal</option>
                                <option value="monthly">Mensal</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                        <div id="col-cat">
                            <label>Categoria</label>
                            <select id="exp-category"></select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="btn-finance-add" class="btn-action" style="background: var(--danger); color: white;" onclick="addFinanceRecord(false)">ADICIONAR</button>
                            <button id="btn-finance-add-paid" class="btn-action" style="background: var(--success); color: white;" onclick="addFinanceRecord(true)">PAGO ‚úÖ</button>
                        </div>
                    </div>
                </div>

                <div class="admin-section" style="margin-bottom: 1rem;">
                    <div class="form-row">
                        <div>
                            <label>Filtrar por Categoria</label>
                            <select id="filter-category" onchange="renderFinanceTable()">
                                <option value="all">Todas as Categorias</option>
                            </select>
                        </div>
                        <div>
                            <label>Buscar por Descri√ß√£o</label>
                            <input type="text" id="filter-search" placeholder="Buscar..." oninput="renderFinanceTable()">
                        </div>
                    </div>
                    <div style="background: #111111; padding: 15px; border-radius: 10px; border: 1px solid var(--border); margin-top: 15px;">
                        <span id="label-total-filtrado" style="font-size: 0.8rem; color: var(--text-muted); display: block;">Total Despesas</span>
                        <strong id="filtered-total" style="color: var(--warn); font-size: 1.2rem;">R$ 0,00</strong>
                    </div>
                </div>
                
                <div class="table-wrapper" id="section-finance-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th class="col-recurrence">Recorr√™ncia</th>
                                <th>Categoria</th>
                                <th>Descri√ß√£o</th>
                                <th class="col-status">Status</th>
                                <th>Valor</th>
                                <th style="text-align: right;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="list-finance"></tbody>
                    </table>
                </div>

                <div id="section-relatorios" style="display: none;">
                    <div class="admin-section">
                        <h4 style="margin-bottom: 1rem; font-size: 1.1rem;">Relat√≥rio Fiscal - Servi√ßos Conclu√≠dos e Vendas</h4>
                        <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                            Como seu sistema ajuda na emiss√£o de notas fiscais:<br>
                            <strong>Fonte de Dados Confi√°vel:</strong> Na Agenda, toda vez que voc√™ marca um atendimento como "Conclu√≠do", ele j√° registra data, cliente, servi√ßo e valor. 
                            Na aba Finan√ßas > Entradas, as vendas de produtos tamb√©m ficam registradas.<br>
                            <strong>Relat√≥rio para o Contador:</strong> Periodicamente (ex.: todo m√™s), voc√™ pode extrair uma lista dos servi√ßos conclu√≠dos e vendas feitas. 
                            Passe essa lista para seu contador, que usar√° os dados para emitir as notas fiscais em lote no sistema oficial.
                        </p>
                        
                        <div class="form-row">
                            <div>
                                <label>Ano</label>
                                <select id="report-year">
                                    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div>
                                <label>M√™s</label>
                                <select id="report-month">
                                    <option value="">Todos os meses</option>
                                    <option value="01">Janeiro</option>
                                    <option value="02">Fevereiro</option>
                                    <option value="03">Mar√ßo</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Maio</option>
                                    <option value="06">Junho</option>
                                    <option value="07">Julho</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div>
                                <label>Semana</label>
                                <select id="report-week">
                                    <option value="">Todo o per√≠odo</option>
                                    <option value="1">Semana 1 (dias 1-7)</option>
                                    <option value="2">Semana 2 (dias 8-14)</option>
                                    <option value="3">Semana 3 (dias 15-21)</option>
                                    <option value="4">Semana 4 (dias 22-28)</option>
                                    <option value="5">Semana 5 (dias 29-31)</option>
                                </select>
                            </div>
                            <div>
                                <button class="btn-action" onclick="generateFiscalReport()" style="margin-top: 1.5rem;">GERAR RELAT√ìRIO</button>
                            </div>
                        </div>

                        <div id="report-results" style="display: none; margin-top: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;">
                                <h5 style="font-size: 1rem;">Resultado do Per√≠odo</h5>
                                <button class="btn-action" onclick="exportFiscalReport()" style="background: var(--success); padding: 8px 16px; font-size: 0.85rem;">EXPORTAR CSV</button>
                            </div>
                            
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Tipo</th>
                                            <th>Cliente</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-body"></tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1.5rem; background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border);">
                                <div>
                                    <strong id="report-total" style="color: var(--primary); font-size: 1.2rem;">Total do per√≠odo: R$ 0,00</strong><br>
                                    <span id="report-summary" style="color: var(--text-muted); font-size: 0.85rem;">0 servi√ßos + 0 produtos + 0 assinaturas</span>
                                </div>
                                <div id="report-period-info" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">
                                    Per√≠odo: -
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-assinaturas" class="tab-content">
                <div class="admin-section">
                    <h4 style="margin-bottom: 1rem; font-size: 1.1rem;">Gerenciar Assinaturas</h4>
                    
                    <div class="form-row">
                        <div><label>Cliente</label><input type="text" id="sub-client" placeholder="Nome do cliente"></div>
                        <div><label>Telefone</label><input type="tel" id="sub-phone" placeholder="28999999999"></div>
                        <div><label>Plano</label>
                            <select id="sub-service" onchange="updatePlanDetails()">
                                <option value="">Selecione um plano...</option>
                                <option value="sempre-alinhado">Sempre Alinhado - R$ 79,90/m√™s</option>
                                <option value="combo-executivo">Combo Executivo - R$ 119,90/m√™s</option>
                                <option value="vip-premium">VIP Premium - R$ 159,90/m√™s</option>
                            </select>
                        </div>
                        <div><label>Valor (R$)</label><input type="number" id="sub-value" step="0.01" readonly></div>
                        <div><label>Data In√≠cio</label><input type="date" id="sub-start-date"></div>
                        <div><label>Status</label>
                            <select id="sub-status">
                                <option value="active">Ativa</option>
                                <option value="inactive">Inativa</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn-action" onclick="addSubscription()">ADICIONAR ASSINATURA</button>
                        </div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Telefone</th>
                                <th>Plano</th>
                                <th>Valor</th>
                                <th>In√≠cio</th>
                                <th>Pr√≥x. Cobran√ßa</th>
                                <th>Status</th>
                                <th style="text-align: right;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="list-subscriptions"></tbody>
                    </table>
                </div>

                <!-- Hist√≥rico de Uso das Assinaturas -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1rem; font-size: 1.1rem;">Hist√≥rico de Uso das Assinaturas</h4>
                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">Veja todos os agendamentos realizados por assinantes nos √∫ltimos 30 dias.</p>
                    
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Servi√ßo</th>
                                    <th>Plano</th>
                                    <th>Uso #</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="subscription-usage-history"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Aba Configura√ß√µes -->
            <div id="tab-configura√ß√µes" class="tab-content">
                <!-- Informa√ß√µes da Barbearia -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Informa√ß√µes da Barbearia</h4>

                    <div class="form-row">
                        <div>
                            <label>Nome da Barbearia</label>
                            <input type="text" id="barbearia-nome" placeholder="Ex: Barbearia do Rei">
                        </div>
                        <div>
                            <label>Telefone/WhatsApp</label>
                            <input type="text" id="barbearia-telefone" placeholder="(28) 99999-9999">
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Endere√ßo Completo</label>
                            <input type="text" id="barbearia-endereco" placeholder="Rua, n√∫mero, bairro, cidade - UF, CEP">
                        </div>
                        <div style="grid-column: span 3;">
                            <label>Link do Google Maps</label>
                            <input type="url" id="barbearia-maps-link" placeholder="https://maps.app.goo.gl/...">
                        </div>
                        <div>
                            <button class="btn-action" onclick="salvarInformacoesBarbearia()" style="background: var(--success);">SALVAR INFORMA√á√ïES</button>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√£o de Hor√°rios -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Hor√°rios de Funcionamento</h4>

                    <div id="horarios-config">
                        <!-- Os dias da semana ser√£o carregados dinamicamente -->
                    </div>

                    <div style="margin-top: 2rem;">
                        <button class="btn-action" disabled style="background: #666; color: #999; cursor: not-allowed;">‚úÖ Auto-salvo</button>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">As altera√ß√µes s√£o salvas automaticamente</p>
                    </div>
                </div>

                <!-- Configura√ß√£o de Dura√ß√£o de Agendamentos -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Dura√ß√£o de Agendamentos</h4>

                    <div class="form-row">
                        <div>
                            <label>Dura√ß√£o padr√£o de cada agendamento (minutos)</label>
                            <select id="duracao-agendamento">
                                <option value="30">30 minutos</option>
                                <option value="40">40 minutos</option>
                                <option value="45">45 minutos</option>
                                <option value="60">1 hora (60 minutos)</option>
                                <option value="90">1 hora e 30 minutos</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn-action" onclick="salvarDuracaoAgendamento()" style="background: var(--success);">SALVAR DURA√á√ÉO</button>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√£o de Assinaturas (ON/OFF) -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Sistema de Assinaturas</h4>

                    <div class="form-row">
                        <div>
                            <label>Status do Sistema de Assinaturas</label>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button id="btn-enable-subscriptions" class="btn-action" onclick="toggleSubscriptionsEnabled(true)" style="background: var(--success); flex: 1;">‚úÖ ATIVAR</button>
                                <button id="btn-disable-subscriptions" class="btn-action" onclick="toggleSubscriptionsEnabled(false)" style="background: var(--danger); flex: 1;">‚ùå DESATIVAR</button>
                            </div>
                            <p id="subscriptions-status" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">Carregando status...</p>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√£o de Relat√≥rio Fiscal -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Relat√≥rio Fiscal</h4>

                    <div class="form-row">
                        <div>
                            <label>Habilitar Funcionalidade de Relat√≥rio Fiscal</label>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button id="btn-enable-fiscal-report" class="btn-action" onclick="toggleFiscalReport(true)" style="background: var(--success); flex: 1;">‚úÖ ATIVAR</button>
                                <button id="btn-disable-fiscal-report" class="btn-action" onclick="toggleFiscalReport(false)" style="background: var(--danger); flex: 1;">‚ùå DESATIVAR</button>
                            </div>
                            <p id="fiscal-report-status" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">Carregando status...</p>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√£o de Servi√ßos de Assinatura -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Configura√ß√£o de Servi√ßos de Assinatura</h4>

                    <div class="form-row">
                        <div>
                            <label>Nome do Plano</label>
                            <input type="text" id="assinatura-nome" placeholder="Ex: Sempre Alinhado">
                        </div>
                        <div>
                            <label>Valor Mensal (R$)</label>
                            <input type="number" id="assinatura-valor" step="0.01" placeholder="79.90">
                        </div>
                        <div>
                            <label>Frequ√™ncia</label>
                            <select id="assinatura-frequencia">
                                <option value="monthly">Mensal</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="semiannual">Semestral</option>
                                <option value="annual">Anual</option>
                            </select>
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Descri√ß√£o (opcional)</label>
                            <textarea id="assinatura-descricao" placeholder="Descri√ß√£o do plano para os clientes" style="width:100%; height:60px; padding:12px; background:#111111; color:#fff; border:1px solid var(--border); border-radius:8px; font-size: 0.9rem;"></textarea>
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Servi√ßos Inclusos no Plano</label>
                            <div id="assinatura-servicos-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 10px; max-height: 300px; overflow-y: auto; padding: 10px; background: #0a0a0a; border-radius: 8px; border: 1px solid var(--border);">
                                <p style="color: var(--text-muted); grid-column: span -1;">Carregando servi√ßos...</p>
                            </div>
                        </div>
                        <div>
                            <button class="btn-action" onclick="salvarServicoAssinatura()" style="background: var(--success);">SALVAR PLANO</button>
                            <button class="btn-action" onclick="cancelarEdicaoServicoAssinatura()" style="background: var(--danger); display: none;" id="btn-cancelar-edicao-assinatura">CANCELAR</button>
                        </div>
                    </div>
                    <input type="hidden" id="assinatura-id-editando" value="">
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Valor</th>
                                <th>Frequ√™ncia</th>
                                <th>Descri√ß√£o</th>
                                <th>Servi√ßos Inclusos</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="list-services-assinatura"></tbody>
                    </table>
                </div>

                <!-- Configura√ß√£o de Servi√ßos -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Configura√ß√£o de Servi√ßos</h4>

                    <div class="form-row">
                        <div>
                            <label>Nome do Servi√ßo</label>
                            <input type="text" id="servico-nome" placeholder="Ex: Corte Masculino">
                        </div>
                        <div>
                            <label>Pre√ßo (R$)</label>
                            <input type="number" id="servico-preco" step="0.01" placeholder="40.00">
                        </div>
                        <div>
                            <label>Dura√ß√£o (minutos)</label>
                            <input type="number" id="servico-duracao" placeholder="30" min="30" step="30">
                        </div>
                        <div>
                            <label>Slots (cada slot = 30min)</label>
                            <input type="number" id="servico-slots" placeholder="1" min="1" value="1">
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Descri√ß√£o Detalhada (opcional)</label>
                            <textarea id="servico-descricao" placeholder="Descri√ß√£o detalhada do servi√ßo para os clientes" style="width:100%; height:60px; padding:12px; background:#111111; color:#fff; border:1px solid var(--border); border-radius:8px; font-size: 0.9rem;"></textarea>
                        </div>
                        <div>
                            <button class="btn-action" onclick="salvarServico()" style="background: var(--success);">SALVAR SERVI√áO</button>
                            <button class="btn-action" onclick="cancelarEdicaoServico()" style="background: var(--danger); display: none;" id="btn-cancelar-edicao">CANCELAR</button>
                        </div>
                    </div>
                    <input type="hidden" id="servico-id-editando" value="">
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Pre√ßo (R$)</th>
                                <th>Dura√ß√£o (min)</th>
                                <th>Slots</th>
                                <th>Descri√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="list-services"></tbody>
                    </table>
                </div>

                <!-- Gerenciamento de Emails Autorizados -->
                <div class="admin-section">
                    <h4 style="margin-bottom: 1.5rem;">Emails Autorizados para Acesso ao Admin</h4>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                        Adicione emails que possam acessar o painel admin. O email <strong>saullinho2008@gmail.com</strong> tem acesso completo incluindo configura√ß√µes. Os outros emails s√≥ ter√£o acesso ao painel (sem acesso √†s configura√ß√µes).
                    </p>

                    <div class="form-row">
                        <div style="grid-column: span 2;">
                            <label>Novo Email</label>
                            <input type="email" id="novo-email-autorizado" placeholder="exemplo@email.com">
                        </div>
                        <div>
                            <button class="btn-action" onclick="adicionarEmailAutorizado()" style="background: var(--success); margin-top: 1.7rem;">ADICIONAR EMAIL</button>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <h5 style="margin-bottom: 1rem; font-size: 1rem;">Emails Autorizados:</h5>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Permiss√£o</th>
                                        <th>A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="list-emails-autorizados"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <button id="back-to-top-btn" class="back-to-top" onclick="backToTop()" aria-label="Voltar ao topo">
            <i data-lucide="chevron-up" id="back-to-top-icon"></i>
        </button>
        
        <div class="toast" id="toast"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, addDoc, serverTimestamp, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

        const firebaseConfig = {
  apiKey: "AIzaSyAi2g57qd4J3ONEjGvTEct69jsdV9F59lg",
  authDomain: "nossa-barbearia.firebaseapp.com",
  projectId: "nossa-barbearia",
  storageBucket: "nossa-barbearia.firebasestorage.app",
  messagingSenderId: "545785512912",
  appId: "1:545785512912:web:a917526f553c21945e6fd5",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Mapeamento de cores por servi√ßo
        const serviceColors = {
            "Corte Masculino": "#0800ff",
            "Barba Completa": "#d0ff00",
            "Combos": "#3cff00",
            "Combo Corte + Barba": "#3cff00",
            "Combo Completo: Cabelo, Barba e Sombrancelha": "#ff6b00",
            "Corte Infantil": "#10b981",
            "Cortesia": "#a0a0a0",
            "Bloqueio": "#ef4444",
            "Outros": "#3b82f6",
            "Assinatura": "#8b5cf6"
        };

        let agendamentosData = [];
        let configDiasData = {};
        let despesasData = [];
        let entradasData = [];
        let financeMode = 'despesas';

        const financeCategories = {
            despesas: ["Produtos", "Aluguel", "Marketing", "Manuten√ß√£o", "Utilidades", "Pessoal", "Outros"],
            entradas: ["Refrigerantes", "Chips / Snacks", "Cremes / Pomadas", "Outros Produtos"]
        };

        let currentCalendarDate = new Date();
        let selectedDateISO = new Date().toISOString().split('T')[0];
        let selectedSlot = null;
        let cortesiaSlots = 1;
        let mainChart = null;
        let pieChart = null;
        let sortClientsByInactivity = true;
        let financeSort = { column: 'data', direction: 'desc' };
        let subscriptionsData = [];
        let servicesData = [];
        let isAssinatura = false;
        let currentUserEmail = null;
        let subscriptionPlansData = []; // Nova vari√°vel para armazenar planos de assinatura
        let emailsAutorizados = ['saullinho2008@gmail.com']; // Lista de emails autorizados
        let isFirstLoadComplete = false; // Flag para rastrear primeiro carregamento completo

        const baseSlots = ["09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30"];

        // Fun√ß√£o para mostrar/ocultar modal de navega√ß√£o
        window.toggleNavModal = () => {
            const modal = document.getElementById('nav-modal');
            const overlay = document.querySelector('.nav-modal-overlay');
            
            const isActive = modal.classList.contains('active');
            
            if (isActive) {
                modal.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                modal.classList.add('active');
                overlay.classList.add('active');
            }
            
            // Atualizar √≠cones quando modal abre
            if (modal.classList.contains('active')) {
                setTimeout(() => {
                    lucide.createIcons();
                }, 10);
            }
        };

        // Fun√ß√£o para rolar ao topo respeitando o container com scroll (admin-panel)
        window.backToTop = () => {
            const panel = document.getElementById('admin-panel');

            // Priorizar rolagem do painel quando houver overflow
            try {
                if (panel && panel.scrollHeight > panel.clientHeight) {
                    panel.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
            } catch (e) {
                // ignore
            }

            // Fallbacks: documentElement e body
            try { document.documentElement.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) {}
            try { document.body.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) {}

            // Pequeno feedback visual para confirmar que o bot√£o funcionou
            try { showToast('Rolando ao topo...', 'info'); } catch(e) {}
        };

        // Garantir que bot√£o funciona mesmo sem onclick inline (mais robusto)
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('back-to-top-btn');
            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    backToTop();
                });
            }
        });

        // Fechar modal de navega√ß√£o
        function closeNavModal() {
            const modal = document.getElementById('nav-modal');
            const overlay = document.querySelector('.nav-modal-overlay');
            
            modal.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Fun√ß√£o para mostrar toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            
            // Definir cor baseada no tipo
            if (type === 'success') {
                toast.style.background = 'var(--success)';
            } else if (type === 'error') {
                toast.style.background = 'var(--danger)';
            } else if (type === 'warning') {
                toast.style.background = 'var(--warn)';
            } else {
                toast.style.background = 'var(--primary)';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }


        // Fun√ß√£o Global para o Toggle de Assinatura
        window.setAssinatura = (val) => {
            isAssinatura = val;
            const btnYes = document.getElementById('assinatura-yes');
            const btnNo = document.getElementById('assinatura-no');
            
            if(btnYes && btnNo) {
                if(val) {
                    btnYes.classList.add('active-primary');
                    btnNo.classList.remove('active-primary');
                } else {
                    btnNo.classList.add('active-primary');
                    btnYes.classList.remove('active-primary');
                }
            }
            updateWarning();
        };

        // Fun√ß√£o Global para os Slots da Cortesia
        window.setCortesiaSlots = (num) => {
            cortesiaSlots = num;
            const btn1 = document.getElementById('cortesia-1');
            const btn2 = document.getElementById('cortesia-2');
            
            if(btn1 && btn2) {
                if(num === 1) {
                    btn1.classList.add('active-primary');
                    btn2.classList.remove('active-primary');
                } else {
                    btn2.classList.add('active-primary');
                    btn1.classList.remove('active-primary');
                }
            }
            updateWarning();
        };

        window.notifyInactive = (nome, telefone, dias) => {
            const clean = telefone.replace(/\D/g, "");
            const phone = clean.startsWith("55") ? clean : "55" + clean;
            const msg = encodeURIComponent(
                `Ol√°, ${nome}! üëã\n\n` +
                `Sentimos sua falta na *${window.barberName || 'FLOW BARBER'}*! ‚úÇÔ∏è\n` +
                `J√° fazem ${dias} dias desde sua √∫ltima visita.\n\n` +
                `Que tal agendar um hor√°rio pra dar aquele tapa no visual? üòâ`
            );
            window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${msg}`);
        };

        window.toggleClientSort = () => {
            sortClientsByInactivity = !sortClientsByInactivity;
            renderClients();
        };

        window.toggleFinanceSort = (column) => {
            if (financeSort.column === column) {
                financeSort.direction = financeSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                financeSort.column = column;
                financeSort.direction = 'desc';
            }
            renderFinanceTable();
        };

        // Atualizar a fun√ß√£o switchTab para verificar permiss√µes de configura√ß√µes
        window.switchTab = (tab) => {
            // Verificar se o usu√°rio pode acessar configura√ß√µes
            // O email principal (saullinho2008@gmail.com) sempre tem acesso
            const isMainAdmin = currentUserEmail && currentUserEmail.toLowerCase() === 'saullinho2008@gmail.com';
            if (tab === 'configura√ß√µes' && !isMainAdmin) {
                showToast('Acesso negado: apenas o administrador pode acessar configura√ß√µes.', 'error');
                return;
            }
            
            // Verificar se assinaturas est√£o habilitadas
            if (tab === 'assinaturas' && !subscriptionsEnabled) {
                showToast('Sistema de assinaturas desabilitado.', 'error');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-modal-item').forEach(i => i.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            // Atualizar t√≠tulo
            const titles = {
                'dashboard': 'Dashboard',
                'agendamentos': 'Agenda',
                'clientes': 'Clientes',
                'assinaturas': 'Assinaturas',
                'finan√ßas': 'Finan√ßas',
                'configura√ß√µes': 'Configura√ß√µes'
            };
            
            const titleText = titles[tab] || tab;
            const currentTabEl = document.getElementById('current-tab');
            if (currentTabEl) currentTabEl.innerText = titleText;
            
            // Ativar item do menu
            const navItems = document.querySelectorAll('.nav-modal-item');
            navItems.forEach(item => {
                if (item.textContent.includes(titleText)) {
                    item.classList.add('active');
                }
            });
            
            // Fechar modal de navega√ß√£o (com delay para garantir fechamento em mobile)
            setTimeout(() => {
                closeNavModal();
            }, 50);
            
            // Executar fun√ß√µes espec√≠ficas da tab
            if(tab === 'dashboard') {
                setTimeout(() => {
                    updateDashboard();
                    updateSimpleDashboard();
                }, 50);
            }
            if(tab === 'agendamentos') {
    renderCalendar();
    // Aguardar um pouco para garantir que os dados est√£o carregados
    setTimeout(() => {
        populateServiceSelect();
        // Garantir que horariosConfig est√° carregado
        if (window.horariosConfig) {
            renderSlots();
        } else {
            // Tentar carregar se n√£o estiver
            loadHorariosFuncionamento().then(() => {
                renderSlots();
            });
        }
    }, 300);
}
            if(tab === 'clientes') renderClients();
            if(tab === 'assinaturas') {
                renderSubscriptions();
                renderSubscriptionUsageHistory();
            }
            if(tab === 'finan√ßas') switchFinanceMode('despesas');
            if(tab === 'configura√ß√µes') {
                setTimeout(() => {
                    renderServices();
                    renderSubscriptionPlans(); // Nova fun√ß√£o para renderizar planos de assinatura
                    renderTabelaEmailsAutorizados(); // Renderizar tabela de emails autorizados
                }, 100);
            }
            
            // Scroll para o topo
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        // Fun√ß√£o para carregar emails autorizados do Firestore
        window.carregarEmailsAutorizados = async () => {
            try {
                const docRef = doc(db, 'configuracoes', 'emailsAutorizados');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    emailsAutorizados = docSnap.data().emails || ['saullinho2008@gmail.com'];
                } else {
                    emailsAutorizados = ['saullinho2008@gmail.com'];
                }
            } catch (error) {
                console.error('Erro ao carregar emails autorizados:', error);
                emailsAutorizados = ['saullinho2008@gmail.com'];
            }
        };

        // Fun√ß√£o para salvar emails autorizados no Firestore
        window.salvarEmailsAutorizados = async () => {
            try {
                const docRef = doc(db, 'configuracoes', 'emailsAutorizados');
                await setDoc(docRef, { emails: emailsAutorizados }, { merge: true });
                renderTabelaEmailsAutorizados();
                showToast('Emails atualizados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar emails:', error);
                showToast('Erro ao salvar emails', 'error');
            }
        };

        // Fun√ß√£o para adicionar um novo email autorizado
        window.adicionarEmailAutorizado = async () => {
            const inputEmail = document.getElementById('novo-email-autorizado');
            const email = inputEmail.value.trim().toLowerCase();

            if (!email) {
                showToast('Por favor, preencha o campo de email', 'warning');
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Por favor, insira um email v√°lido', 'warning');
                return;
            }

            // Verificar se j√° existe
            if (emailsAutorizados.includes(email)) {
                showToast('Este email j√° est√° autorizado', 'warning');
                return;
            }

            // Adicionar √† lista
            emailsAutorizados.push(email);
            await salvarEmailsAutorizados();
            inputEmail.value = '';
        };

        // Fun√ß√£o para remover um email autorizado
        window.removerEmailAutorizado = async (email) => {
            // N√£o permitir remover o email principal
            if (email === 'saullinho2008@gmail.com') {
                showToast('N√£o √© poss√≠vel remover o email principal', 'warning');
                return;
            }

            if (confirm(`Deseja remover o email ${email}?`)) {
                emailsAutorizados = emailsAutorizados.filter(e => e !== email);
                await salvarEmailsAutorizados();
            }
        };

        // Fun√ß√£o para renderizar a tabela de emails autorizados
        window.renderTabelaEmailsAutorizados = () => {
            const tbody = document.getElementById('list-emails-autorizados');
            if (!tbody) return;

            tbody.innerHTML = '';

            emailsAutorizados.forEach(email => {
                const isMain = email === 'saullinho2008@gmail.com';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${email}</td>
                    <td>${isMain ? '<span style="color: var(--warn);">Completo (Admin)</span>' : '<span style="color: var(--success);">Painel (sem Config.)</span>'}</td>
                    <td>
                        <button class="btn-action" onclick="removerEmailAutorizado('${email}')" style="background: ${isMain ? '#666; cursor: not-allowed; opacity: 0.5;' : 'var(--danger);'}; padding: 6px 12px; font-size: 0.85rem;" ${isMain ? 'disabled' : ''}>
                            <i data-lucide="trash-2"></i> REMOVER
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            lucide.createIcons();
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserEmail = user.email;
                

                
                // Carregar emails autorizados e verificar acesso
                carregarEmailsAutorizados().then(() => {
                    // Verificar se o email est√° autorizado
                    const emailAutorizado = emailsAutorizados.includes(currentUserEmail.toLowerCase());
                    
                    if (!emailAutorizado) {
                        // Email n√£o est√° autorizado
                        signOut(auth);
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('admin-panel').style.display = 'none';
                        const loginError = document.getElementById('login-error');
                        loginError.innerText = 'Este email n√£o est√° autorizado para acessar o admin.';
                        loginError.style.display = 'block';
                        return;
                    }
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    
                    // Atualizar a aba atual para dashboard ao logar
                    try { switchTab('dashboard'); } catch(e) { /* ignore */ }
                    
                    // Esconder item de configura√ß√µes do menu se n√£o for o email permitido
                    if (currentUserEmail !== 'saullinho2008@gmail.com') {
                        const configMenuItem = document.getElementById('configuracoes-menu-item');
                        if (configMenuItem) {
                            configMenuItem.style.display = 'none';
                        }
                    } else {
                        // Se for o email principal, mostrar o item de configura√ß√µes
                        const configMenuItem = document.getElementById('configuracoes-menu-item');
                        if (configMenuItem) {
                            configMenuItem.style.display = 'flex';
                        }
                    }
                    
                    initListeners();
                    showToast('Login realizado com sucesso!', 'success');
                });
            } else {
                currentUserEmail = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        const loginError = document.getElementById('login-error');
        const btnLogin = document.getElementById('btn-login');
        if(btnLogin) {
            btnLogin.onclick = async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    loginError.innerText = "Por favor, preencha todos os campos.";
                    loginError.style.display = 'block';
                    return;
                }

                btnLogin.disabled = true;
                btnLogin.innerHTML = '<i data-lucide="loader-2" class="spin"></i> AUTENTICANDO...';
                loginError.style.display = 'none';

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    btnLogin.disabled = false;
                    btnLogin.innerHTML = 'ENTRAR';
                    loginError.style.display = 'block';
                    if (error.code === 'auth/invalid-credential') {
                        loginError.innerText = "Credenciais inv√°lidas.";
                    } else {
                        loginError.innerText = "Erro: " + error.message;
                    }
                }
            };
        }

        window.logout = () => {
            if (confirm('Deseja realmente sair?')) {
                signOut(auth);
                showToast('Logout realizado com sucesso', 'info');
            }
        };

        function initListeners() {
            // Carregar emails autorizados
            carregarEmailsAutorizados();
            
            onSnapshot(collection(db, "agendamentos"), snap => {
                agendamentosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                try {
                    // Usar servicesData do banco de dados em vez do select (mais confi√°vel)
                    const options = servicesData && servicesData.length > 0 
                        ? servicesData.map(s => ({ name: (s.name || '').trim(), price: s.price || 0 }))
                        : [];

                    agendamentosData = agendamentosData.map(a => {
                        const out = { ...a };
                        out.preco = Number(out.preco) || 0;

                        if (options.length > 0) {
                            const originalServ = (out.servico || '').toString();
                            const target = originalServ.toLowerCase();

                            let match = options.find(o => o.name.toLowerCase() === target || o.name.toLowerCase().includes(target) || target.includes(o.name.toLowerCase()));

                            if (!match && out.preco !== undefined) {
                                match = options.find(o => Math.abs((o.price || 0) - Number(out.preco || 0)) < 0.01);
                            }

                            if (match) {
                                if (out.preco === undefined || out.preco === 0) out.preco = match.price;
                                out.servico = match.name;
                            }
                        }

                        return out;
                    });
                } catch (e) {
                    console.warn('Normalization failed:', e);
                }

                // S√≥ atualizar dashboards se tiver dados suficientes
                if (isFirstLoadComplete && (agendamentosData.length > 0 || subscriptionsData.length > 0)) {
                    updateDashboard();
                    updateSimpleDashboard();
                }
                renderClients();
                renderCalendar();
                renderSubscriptionUsageHistory();
                renderSlots();
            });

            onSnapshot(collection(db, "config_dias"), snap => {
                configDiasData = {};
                snap.forEach(d => configDiasData[d.id] = d.data());
                renderCalendar();
                renderSlots();
            });

           onSnapshot(collection(db, "services"), snap => {
    servicesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    console.log('Servi√ßos carregados:', servicesData.length, 'itens');
    
    // Verificar dados
    servicesData.forEach((service, index) => {
        if (!service.name || !service.price || !service.duration) {
            console.warn(`Servi√ßo ${index} incompleto:`, service);
        }
    });
    
    // Se n√£o houver servi√ßos, criar padr√µes
    if (servicesData.length === 0) {
        const defaultServices = [
            { name: "Corte Masculino", duration: 30, price: 25 },
            { name: "Corte Masculino s√≥ Tesoura", duration: 45, price: 30 },
            { name: "Corte Masculino s√≥ M√°quina", duration: 20, price: 20 },
            { name: "Barba Completa", duration: 30, price: 25 },
            { name: "Combos", duration: 60, price: 45 },
            { name: "Corte Infantil", duration: 30, price: 35 },
            { name: "Pezinho", duration: 30, price: 10 },
            { name: "Sobrancelha", duration: 15, price: 15 },
            { name: "Pigmenta√ß√£o", duration: 20, price: 25 },
            { name: "Depila√ß√£o Nariz/Orelha", duration: 10, price: 10 }
        ];
        console.log('Criando servi√ßos padr√£o (incluso Pezinho)...');
        defaultServices.forEach(async (service) => {
            try {
                const docRef = await addDoc(collection(db, "services"), service);
                console.log('Servi√ßo criado:', service.name, 'com ID:', docRef.id);
            } catch (e) {
                console.error('Erro ao criar servi√ßo:', service.name, e);
            }
        });
    }
    
    // Atualizar interfaces que dependem de servi√ßos
    renderServices();
    renderServicosAssinaturaForm();
    
    // Se a aba de agenda estiver aberta, atualizar o select
    if (document.getElementById('tab-agendamentos')?.classList.contains('active')) {
        console.log('Atualizando select de servi√ßos na aba ativa');
        populateServiceSelect();
    }
    
    // For√ßar atualiza√ß√£o do dashboard se estiver ativo
    if (document.getElementById('tab-dashboard')?.classList.contains('active')) {
        updateSimpleDashboard();
    }
});

            onSnapshot(collection(db, "despesas"), snap => {
                despesasData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(financeMode === 'despesas') renderFinanceTable();
                updateDashboard();
                updateSimpleDashboard();
            });

            onSnapshot(collection(db, "entradas_produtos"), snap => {
                entradasData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(financeMode === 'entradas') renderFinanceTable();
                updateDashboard();
                updateSimpleDashboard();
            });

            onSnapshot(collection(db, "assinaturas"), snap => {
                subscriptionsData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderSubscriptions();
                renderSubscriptionUsageHistory();
                updateSimpleDashboard();
            });
            
            // NOVO LISTENER PARA PLANOS DE ASSINATURA
            onSnapshot(collection(db, "subscription_plans"), snap => {
                subscriptionPlansData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderSubscriptionPlans();
                populateSubscriptionPlansSelect(); // Atualizar select na aba de assinaturas
            });
            
            // Chamar fun√ß√£o de fallback para garantir que os servi√ßos est√£o carregados
            ensureServicesLoaded();
            
            // Garantir sincroniza√ß√£o de todos os dados com maior delay
            setTimeout(() => {
                ensureDataSync().then(() => {
                    console.log('üîÑ Inicializando dashboards com dados sincronizados...');
                    
                    // Re-normalizar agendamentos com servicesData carregados
                    if (agendamentosData.length > 0 && servicesData.length > 0) {
                        console.log('üìã Re-normalizando agendamentos com servi√ßos carregados...');
                        agendamentosData = agendamentosData.map(a => {
                            const out = { ...a };
                            out.preco = Number(out.preco) || 0;
                            
                            const originalServ = (out.servico || '').toString();
                            const target = originalServ.toLowerCase();
                            
                            // Tentar casar com servi√ßos cadastrados
                            const matched = servicesData.find(s => {
                                const nameLower = (s.name || '').toString().toLowerCase();
                                return nameLower === target || 
                                       nameLower.includes(target) || 
                                       target.includes(nameLower);
                            });
                            
                            if (matched) {
                                out.servico = matched.name;
                                if (out.preco === undefined || out.preco === 0) {
                                    out.preco = matched.price;
                                }
                            }
                            
                            return out;
                        });
                        console.log('‚úÖ Agendamentos re-normalizados:', agendamentosData.length);
                    }
                    
                    updateDashboard();
                    updateSimpleDashboard();
                });
            }, 1500);
        }

        // Fun√ß√£o para atualizar a vis√£o simplificada
        function updateSimpleDashboard() {
            // PROTE√á√ÉO: Garantir que dados essenciais est√£o carregados
            if (!agendamentosData || agendamentosData.length === 0 || !subscriptionsData) {
                console.warn('updateSimpleDashboard: Alguns dados ainda n√£o carregados, aguardando...');
                setTimeout(() => {
                    if (agendamentosData && agendamentosData.length > 0 && subscriptionsData) {
                        updateSimpleDashboard();
                    }
                }, 300);
                return;
            }
            
            // 1. Valor arrecadado no m√™s
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            let monthRevenue = 0;
            
            // Servi√ßos conclu√≠dos no m√™s (excluindo assinaturas)
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            monthRevenue += calculateRevenueExcludingSubscriptions(agendamentosData, monthStart, monthEnd);
            
            // Vendas de produtos no m√™s
            if (entradasData && Array.isArray(entradasData)) {
                entradasData.forEach(e => {
                    if (e.data) {
                        const saleDate = new Date(e.data + 'T00:00:00');
                        if (saleDate >= firstDayOfMonth && saleDate <= lastDayOfMonth) {
                            monthRevenue += Number(e.valor || 0);
                        }
                    }
                });
            }
            
            // Assinaturas pagas no m√™s
            if (subscriptionsData && Array.isArray(subscriptionsData)) {
                subscriptionsData.forEach(sub => {
                    if (sub.paymentStatus === 'paid' && sub.lastPaymentDate) {
                        const paymentDate = new Date(sub.lastPaymentDate + 'T00:00:00');
                        if (paymentDate >= firstDayOfMonth && paymentDate <= lastDayOfMonth) {
                            monthRevenue += Number(sub.value || 0);
                        }
                    }
                });
            }
            
            document.getElementById('simple-month-revenue').innerText = 
                `R$ ${monthRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            // 2. Agendamentos hoje (apenas futuros)
            const todayStr = today.toISOString().split('T')[0];
            const todayBookings = agendamentosData.filter(a => 
                a.data === todayStr && 
                a.status !== 'blocked' && 
                a.status !== 'completed' &&
                a.nome !== 'BLOQUEADO'
            ).length;
            
            document.getElementById('simple-today-bookings').innerText = todayBookings;
            
            // 3. Quantidade de assinantes ativos
            const activeSubscribers = subscriptionsData.filter(sub => 
                sub.status === 'active'
            ).length;
            
            document.getElementById('simple-subscribers').innerText = activeSubscribers;
            
            // 4. Agendamentos por assinatura hoje
            const subscriptionBookingsToday = agendamentosData.filter(a => 
                a.data === todayStr && 
                a.status !== 'blocked' && 
                a.nome !== 'BLOQUEADO' &&
                a.isSubscription === true
            ).length;
            
            document.getElementById('simple-subscription-bookings').innerText = subscriptionBookingsToday;
            
            // 5. Agendamentos de hoje (apenas futuros)
            const upcomingList = document.getElementById('simple-upcoming-list');
            const todaysAgendamentos = agendamentosData
                .filter(a => 
                    a.data === todayStr && 
                    a.status !== 'blocked' && 
                    a.status !== 'completed' &&
                    a.nome !== 'BLOQUEADO'
                )
                .sort((a, b) => {
                    // Ordenar por hora
                    const timeA = a.hora || '00:00';
                    const timeB = b.hora || '00:00';
                    return timeA.localeCompare(timeB);
                });
            
            if (todaysAgendamentos.length === 0) {
                upcomingList.innerHTML = '<div class="no-upcoming">Nenhum agendamento hoje</div>';
            } else {
                upcomingList.innerHTML = '';
                
                todaysAgendamentos.forEach(agend => {
                    const clientName = agend.nome || agend.cliente || 'Cliente n√£o informado';
                    const service = (agend.servico && agend.servico.trim()) ? agend.servico : (agend.isSubscription ? 'Servi√ßo por assinatura' : 'Servi√ßo n√£o informado');
                    const time = agend.hora || '--:--';
                    
                    // Verificar se √© assinante
                    const isSubscriber = agend.isSubscription === true;
                    
                    // Todos os agendamentos futuros s√£o "Agendado"
                    const statusClass = isSubscriber ? 'subscriber' : 'confirmed';
                    const statusText = isSubscriber ? 'Assinante' : 'Agendado';
                    
                    const clickAction = `onclick="completeUpcomingBooking('${agend.id}')"`; 
                    const cursorStyle = 'cursor: pointer;';
                    
                    upcomingList.innerHTML += `
                        <div class="upcoming-client-item" ${clickAction} style="${cursorStyle}">
                            <div class="client-info">
                                <div class="client-name">${clientName}</div>
                                <div class="client-service">${service}</div>
                                <div class="client-time">${time}</div>
                            </div>
                            <div class="client-status ${statusClass}">${statusText}</div>
                        </div>
                    `;
                });
            }
            
            // Atualizar √≠cones
            lucide.createIcons();
        }

        window.changeMonth = (v) => { 
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + v); 
            renderCalendar(); 
        };

        function renderCalendar() {
    const grid = document.getElementById('calendar-body');
    const label = document.getElementById('calendar-month-year');
    if(!grid || !label) return;

    grid.innerHTML = '';
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    label.innerText = new Intl.DateTimeFormat('pt-BR', {month:'long', year:'numeric'}).format(currentCalendarDate).toUpperCase();

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="calendar-day" style="opacity:0"></div>`;

    for(let d=1; d<=daysInMonth; d++) {
        const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        
        // CORRE√á√ÉO: Obter dia da semana corretamente
        const dateObj = new Date(year, month, d);
        const dayOfWeek = dateObj.getDay(); // 0 = Domingo, 1 = Segunda, etc.
        
        // Obter nome do dia
        const dayNames = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
        const dayName = dayNames[dayOfWeek];
        
        // Verificar se o dia est√° fechado nas configura√ß√µes de hor√°rios
        const daySchedule = window.horariosConfig && window.horariosConfig[dayName];
        const isClosedBySchedule = (daySchedule && daySchedule.abre === false);
        
        const config = configDiasData[iso] || { status: (isClosedBySchedule ? 'closed' : 'open') };
        const dayAgends = agendamentosData.filter(a => a.data === iso);

        const div = document.createElement('div');
        div.className = `calendar-day ${iso === selectedDateISO ? 'selected' : ''} ${config.status === 'closed' ? 'closed' : ''}`;
        
        // Verificar se h√° agendamentos por assinatura
        const hasSubscriptionBooking = dayAgends.some(a => a.isSubscription);
        if (hasSubscriptionBooking) {
            div.classList.add('subscription');
        }

        div.onclick = async () => {
            selectedDateISO = iso;
            renderCalendar();
            renderSlots();
        };
        
        // Adicionar √≠cone se for dia fechado por hor√°rio
        let closedIcon = '';
        if (isClosedBySchedule && config.status !== 'closed') {
            closedIcon = '<div style="position: absolute; top: 2px; right: 2px; font-size: 0.7rem; color: var(--text-muted);">‚è∏Ô∏è</div>';
        }
        
        div.innerHTML = `<div class="day-number">${d}</div>${closedIcon}`;
        
        dayAgends.forEach(a => {
            const baseService = (a.servico || "").replace(" (Autismo)", "").replace(" (Assinatura)", "");
            let color = a.status === 'blocked' ? serviceColors["Bloqueio"] : (serviceColors[baseService] || serviceColors["Outros"]);
            
            if (a.isSubscription) {
                color = 'var(--subscription)';
            }
            
            div.innerHTML += `<span style="width:4px;height:4px;background:${color};display:inline-block;margin:1px;border-radius:1px"></span>`;
        });
        grid.appendChild(div);
    }
    
    // Atualizar √≠cones
    lucide.createIcons();
}

        function renderSlots() {
    const grid = document.getElementById('slots-grid');
    if(!grid) return;
    document.getElementById('selected-date-label').innerText = selectedDateISO.split('-').reverse().join('/');
    document.getElementById('slot-editor').style.display = 'none';
    grid.innerHTML = '';

    const config = configDiasData[selectedDateISO] || {};
    
    // CORRE√á√ÉO: Obter dia da semana corretamente (considerando fuso hor√°rio do Brasil)
    const dateParts = selectedDateISO.split('-').map(Number);
    const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
    const dayOfWeek = dateObj.getDay(); // 0 = Domingo, 1 = Segunda, etc.
    
    // Mapear para os nomes dos dias usados nas configura√ß√µes
    const dayNames = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
    const dayName = dayNames[dayOfWeek];
    
    console.log(`Data: ${selectedDateISO}, Dia da semana: ${dayOfWeek} (${dayName})`);
    
    // Carregar configura√ß√µes de hor√°rios
    let daySchedule = window.horariosConfig && window.horariosConfig[dayName];
    
    // Se o dia estiver fechado nas configura√ß√µes OU estiver marcado como fechado no configDiasData
    const isClosedBySchedule = (daySchedule && daySchedule.abre === false);
    const isClosedByConfig = (config.status === 'closed');
    
    console.log(`Fechado por hor√°rios: ${isClosedBySchedule}, Fechado por config: ${isClosedByConfig}`);
    
    if (isClosedBySchedule || isClosedByConfig) {
        grid.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Dia Fechado</div>';
        return;
    }

    // GERAR HOR√ÅRIOS COM BASE NAS CONFIGURA√á√ïES
    let slots = [];
    
    if (daySchedule && daySchedule.abre !== false) {
        // Usar hor√°rios configurados
        const startTime = daySchedule.abertura || '09:00';
        const endTime = daySchedule.fechamento || '18:00';
        const lunchStart = daySchedule.almocoInicio || '12:00';
        const lunchEnd = daySchedule.almocoFim || '13:00';
        
        slots = generateTimeSlots(startTime, endTime, lunchStart, lunchEnd);
    } else {
        // Usar slots padr√£o como fallback
        slots = [...baseSlots];
    }
    
    // Adicionar slots extras se existirem
    if (config.extraSlots) {
        slots = [...slots, ...config.extraSlots].sort();
    }

    // RENDERIZAR OS SLOTS (o resto da fun√ß√£o permanece igual)
    slots.forEach((time, index) => {
        const agend = agendamentosData.find(a => a.data === selectedDateISO && a.hora === time);
        const btn = document.createElement('div');
        
        let isPartOfLong = false;
        if (index > 0) {
            const prevTime = slots[index - 1];
            const prevAgend = agendamentosData.find(a => a.data === selectedDateISO && a.hora === prevTime);
            if (prevAgend && prevAgend.slots === 2) isPartOfLong = true;
        }

        const isEditing = selectedSlot && selectedSlot.time === time;
        btn.className = `slot-btn ${agend ? (agend.status === 'blocked' ? 'blocked' : 'occupied') : ''} ${isPartOfLong ? 'part-of-long' : ''} ${isEditing ? 'active-editing' : ''}`;
        
        if (agend) {
            let displayName = agend.nome || agend.cliente || '...';
            if(agend.status === 'completed') {
                displayName += ' ‚úÖ';
            }
            
            if (agend.isSubscription) {
                displayName += ' üëë';
            }
            
            btn.innerText = `${time} - ${agend.status === 'blocked' ? 'BLOQUEADO' : displayName}`;
            const baseService = (agend.servico || "").replace(" (Autismo)", "").replace(" (Assinatura)", "");
            let sColor = agend.status === 'blocked' ? serviceColors["Bloqueio"] : (serviceColors[baseService] || serviceColors["Outros"]);
            
            if (agend.isSubscription) {
                sColor = 'var(--subscription)';
            }
            
            btn.style.borderLeft = `3px solid ${sColor}`;
        } else if (isPartOfLong) {
            const owner = agendamentosData.find(a => a.data === selectedDateISO && a.hora === slots[index-1]);
            const ownerName = owner ? (owner.nome || owner.cliente || '...') : '...';
            btn.innerText = `${time} - (${ownerName})`;
            btn.style.opacity = "0.5";
        } else {
            btn.innerText = time;
        }

        btn.onclick = () => {
            if (isPartOfLong) return;
            openSlotEditor(time, agend, slots, index);
        };
        grid.appendChild(btn);
    });
    lucide.createIcons();
}

        function openSlotEditor(time, agend, allSlots, index) {
            selectedSlot = { time, agend, allSlots, index };
            renderSlots();
            
            document.getElementById('slot-editor').style.display = 'block';
            document.getElementById('editor-title').innerText = `Hor√°rio: ${time}`;
            const editClientVal = agend ? ((agend.nome === 'BLOQUEADO' || agend.cliente === 'BLOQUEADO') ? '' : (agend.nome || agend.cliente || '')) : '';
            document.getElementById('edit-client').value = editClientVal;
            document.getElementById('edit-phone').value = agend?.telefone || '';
            
            const serviceSelect = document.getElementById('edit-service');
            if (agend && agend.servico) {
                const target = agend.servico.toString().toLowerCase();
                for (let i = 0; i < serviceSelect.options.length; i++) {
                    const optName = serviceSelect.options[i].value.split('|')[0].toLowerCase();
                    if (optName === target || optName.includes(target) || target.includes(optName)) {
                        serviceSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            setCortesiaSlots(agend?.slots || 1);
            
            // Resetar estado de assinatura para falso por padr√£o
            if (agend && agend.isSubscription === true) {
                setAssinatura(true);
            } else {
                setAssinatura(false);
            }

            // Mostrar detalhes da assinatura se for um agendamento por assinatura
            const subscriptionDetails = document.getElementById('subscription-details');
            if (agend?.isSubscription) {
                const subscription = subscriptionsData.find(sub => 
                    sub.client === (agend.nome || agend.cliente) && 
                    sub.status === 'active'
                );
                
                if (subscription) {
                    const usedServices = subscription.usedServices || 0;
                    let totalServices;
                    if (subscription.plan === 'sempre-alinhado') totalServices = 7;
                    else if (subscription.plan === 'combo-executivo') totalServices = 4;
                    else if (subscription.plan === 'vip-premium') totalServices = Infinity;
                    else totalServices = 12;
                    
                    subscriptionDetails.innerHTML = `
                        <div class="subscription-usage-detail">
                            <h4>üëë Detalhes da Assinatura</h4>
                            <div class="usage-item">
                                <span>Plano:</span>
                                <span><strong>${subscription.plan === 'sempre-alinhado' ? 'Sempre Alinhado' : subscription.plan === 'combo-executivo' ? 'Combo Executivo' : 'VIP Premium'}</strong></span>
                            </div>
                            <div class="usage-item">
                                <span>Servi√ßos utilizados:</span>
                                <span><strong>${usedServices}/${totalServices}</strong></span>
                            </div>
                            <div class="usage-item">
                                <span>Uso atual:</span>
                                <span><strong>${agend.subscriptionUseNumber || 1}</strong></span>
                            </div>
                        </div>
                    `;
                    subscriptionDetails.style.display = 'block';
                } else {
                    subscriptionDetails.style.display = 'none';
                }
            } else {
                subscriptionDetails.style.display = 'none';
            }

            document.getElementById('edit-observations').value = agend?.observacoes || '';
            document.getElementById('btn-cancel-booking').style.display = agend ? 'block' : 'none';
            document.getElementById('btn-complete-booking').style.display = (agend && agend.status !== 'completed' && agend.status !== 'blocked') ? 'block' : 'none';
            
            const btnWhatsapp = document.getElementById('btn-whatsapp-client');
            if (agend && agend.status !== 'blocked') {
                btnWhatsapp.style.display = 'flex';
                btnWhatsapp.onclick = () => {
                    const telefone = agend.telefone || prompt("Insira o n√∫mero de WhatsApp do cliente (com DDD):", "2899082741");
                    if(!telefone) return;
                    const cleanPhone = telefone.replace(/\D/g, "");
                    const fullPhone = cleanPhone.startsWith("55") ? cleanPhone : "55" + cleanPhone;
                    const displayName = agend.nome || agend.cliente || 'cliente';
                    const msg = encodeURIComponent(`Ol√°, ${displayName}! üëã\n\nEstou passando para confirmar o seu agendamento na *${window.barberName || 'FLOW BARBER'}*.\n\nüìÖ Data: ${agend.data.split('-').reverse().join('/')}\n‚è∞ Hora: ${agend.hora}h\n‚úÇÔ∏è Servi√ßo: ${agend.servico}\n\nPodemos confirmar? üòâ`);
                    window.open(`https://api.whatsapp.com/send?phone=${fullPhone}&text=${msg}`);
                };
            } else {
                btnWhatsapp.style.display = 'none';
            }
            updateWarning();
        }

        function updateWarning() {
    const serviceSelect = document.getElementById('edit-service');
    if(!serviceSelect) return;

    const servRaw = serviceSelect.value.split('|');
    const servName = servRaw[0];
    const isInfantil = servName.includes("Infantil");
    const isCortesia = servName.includes("Cortesia");
    const isBloqueio = servName.includes("Bloqueio");
    
    const cortesiaContainer = document.getElementById('cortesia-slots-container');
    const assinaturaContainer = document.getElementById('assinatura-container');
    const observationsContainer = document.getElementById('observations-container');
    
    cortesiaContainer.style.display = isCortesia ? 'block' : 'none';
    observationsContainer.style.display = isInfantil ? 'block' : 'block'; // Sempre mostrar observa√ß√µes
    
    // Mostrar container de assinatura para todos os servi√ßos EXCETO Cortesia e Bloqueio
    if (isCortesia || isBloqueio) {
        assinaturaContainer.style.display = 'none';
        // Se for cortesia ou bloqueio, for√ßar assinatura como false
        if (isAssinatura) {
            setAssinatura(false);
        }
    } else {
        assinaturaContainer.style.display = 'block';
    }

    let slotsNeeded = parseInt(servRaw[2]);
    if (isCortesia) slotsNeeded = cortesiaSlots;

    const warning = document.getElementById('warning-double');
    if(warning) warning.style.display = (slotsNeeded > 1) ? 'block' : 'none';
}

        window.completeUpcomingBooking = async (bookingId) => {
            if(confirm('Confirmar que o cliente compareceu e finalizar atendimento? (O valor entrar√° na receita bruta)')){
                try {
                    await updateDoc(doc(db, "agendamentos", bookingId), { status: 'completed' });
                    showToast('Atendimento conclu√≠do com sucesso!', 'success');
                    updateSimpleDashboard(); // Atualizar dashboard ap√≥s conclus√£o
                } catch(e) { 
                    showToast('Erro ao finalizar: ' + e.message, 'error');
                }
            }
        };

        window.cancelBooking = async () => {
            if(!selectedSlot || !selectedSlot.agend) return;
            const ag = selectedSlot.agend;

            if(confirm('Cancelar agendamento?')) {
                try {
                    await deleteDoc(doc(db, "agendamentos", ag.id));
                    showToast('Agendamento cancelado!', 'info');
                    document.getElementById('slot-editor').style.display = 'none';
                    selectedSlot = null;
                    renderSlots();
                } catch(e) {
                    showToast('Erro ao cancelar: ' + e.message, 'error');
                }
            }
        };

        window.toggleBlockSlot = async () => {
            const data = {
                nome: "BLOQUEADO", data: selectedDateISO, hora: selectedSlot.time,
                servico: "Bloqueio", preco: 0, status: 'blocked', slots: 1, timestamp: new Date()
            };
            try {
                if(selectedSlot.agend) {
                    await updateDoc(doc(db, "agendamentos", selectedSlot.agend.id), data);
                } else {
                    await addDoc(collection(db, "agendamentos"), data);
                }
                showToast('Hor√°rio bloqueado com sucesso!', 'info');
                document.getElementById('slot-editor').style.display = 'none';
                selectedSlot = null;
                renderSlots();
            } catch(e) {
                showToast('Erro ao bloquear hor√°rio: ' + e.message, 'error');
            }
        };

        window.saveBooking = async () => {
            const clientName = document.getElementById('edit-client').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const serviceSelect = document.getElementById('edit-service');
            const serviceRaw = serviceSelect.value.split('|');
            const serviceName = serviceRaw[0];
            const servicePrice = parseFloat(serviceRaw[1]);
            const serviceSlots = parseInt(serviceRaw[2]);
            const observations = document.getElementById('edit-observations').value.trim();

            if (!clientName) {
                showToast('Nome do cliente √© obrigat√≥rio!', 'warning');
                return;
            }

            if (!serviceSelect.value) {
                showToast('Selecione um servi√ßo!', 'warning');
                return;
            }

            // Se for por assinatura, o pre√ßo deve ser 0
            const finalPrice = isAssinatura ? 0 : servicePrice;

            // Preparar dados do agendamento
            const bookingData = {
                nome: clientName,
                cliente: clientName,
                telefone: phone,
                servico: serviceName,
                preco: finalPrice,
                data: selectedDateISO,
                hora: selectedSlot.time,
                status: 'confirmed',
                slots: serviceSlots,
                observacoes: observations,
                timestamp: new Date()
            };

            // Adicionar campos espec√≠ficos para assinatura
            if (isAssinatura) {
                bookingData.isSubscription = true;
                
                // S√≥ incrementar uso se for um NOVO agendamento (n√£o atualiza√ß√£o)
                if (!selectedSlot.agend) {
                    // Encontrar a assinatura do cliente para determinar o uso atual
                    const clientSubscription = subscriptionsData.find(sub => 
                        sub.client === clientName && sub.status === 'active'
                    );
                    
                    if (clientSubscription) {
                        const currentUsage = clientSubscription.usedServices || 0;
                        bookingData.subscriptionUseNumber = currentUsage + 1;
                        
                        // Atualizar contador de uso da assinatura
                        await updateDoc(doc(db, "assinaturas", clientSubscription.id), {
                            usedServices: currentUsage + 1,
                            lastUseDate: selectedDateISO
                        });
                    }
                } else {
                    // Se for atualiza√ß√£o, manter o n√∫mero de uso existente
                    bookingData.subscriptionUseNumber = selectedSlot.agend.subscriptionUseNumber || 1;
                }
            }

            try {
                if (selectedSlot.agend) {
                    // Atualizar agendamento existente
                    await updateDoc(doc(db, "agendamentos", selectedSlot.agend.id), bookingData);
                    showToast('Agendamento atualizado com sucesso!', 'success');
                } else {
                    // Criar novo agendamento
                    await addDoc(collection(db, "agendamentos"), bookingData);
                    showToast('Agendamento criado com sucesso!', 'success');
                }

                document.getElementById('slot-editor').style.display = 'none';
                selectedSlot = null;
                renderSlots();
            } catch(e) {
                showToast('Erro ao salvar agendamento: ' + e.message, 'error');
            }
        };

        window.toggleDayStatus = async (status) => {
            try {
                await setDoc(doc(db, "config_dias", selectedDateISO), { status, updatedAt: new Date() }, { merge: true });
                renderSlots();
                showToast(`Dia ${selectedDateISO} atualizado para: ${status === 'closed' ? 'FECHADO' : 'ABERTO'}`, 'success');
            } catch (e) { 
                showToast('Erro ao atualizar status do dia: ' + e.message, 'error');
            }
        };

        window.addExtraSlot = async () => {
            const configRef = doc(db, "config_dias", selectedDateISO);
            const snap = await getDoc(configRef);
            const config = snap.exists() ? snap.data() : {};
            const currentSlots = config.extraSlots ? [...baseSlots, ...config.extraSlots].sort() : [...baseSlots].sort();
            
            const lastTime = currentSlots[currentSlots.length - 1];
            const [h, m] = lastTime.split(':').map(Number);
            let nextM = m + 40;
            let nextH = h;
            if(nextM >= 60) { nextH++; nextM -= 60; }
            const newTime = `${String(nextH).padStart(2,'0')}:${String(nextM).padStart(2,'0')}`;
            
            const extras = config.extraSlots || [];
            extras.push(newTime);
            await setDoc(configRef, { extraSlots: extras }, { merge: true });
            showToast('Hor√°rio extra adicionado com sucesso!', 'success');
            renderSlots();
        };

        let currentPeriod = 'month';
        function setDashboardPeriod(p) {
            currentPeriod = p;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('period-' + p).classList.add('active');
            updateDashboard();
        }
        
        document.getElementById('period-month').onclick = () => setDashboardPeriod('month');
        document.getElementById('period-week').onclick = () => setDashboardPeriod('week');
        document.getElementById('period-year').onclick = () => setDashboardPeriod('year');

        function getPeriodRange(p) {
            const now = new Date();
            if (p === 'month') {
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const end = new Date(now.getFullYear(), now.getMonth()+1, 1);
                return {start, end};
            } else if (p === 'week') {
                const start = new Date(now);
                const day = (start.getDay() + 6) % 7; 
                start.setHours(0,0,0,0);
                start.setDate(start.getDate() - day);
                const end = new Date(start);
                end.setDate(start.getDate() + 7);
                return {start, end};
            } else {
                const start = new Date(now.getFullYear(), 0, 1);
                const end = new Date(now.getFullYear()+1, 0, 1);
                return {start, end};
            }
        }

        function updateDashboard() {
            // PROTE√á√ÉO: Garantir que dados essenciais est√£o carregados
            if (!agendamentosData || agendamentosData.length === 0) {
                console.warn('updateDashboard: agendamentosData ainda n√£o carregado, aguardando...');
                setTimeout(() => {
                    if (agendamentosData && agendamentosData.length > 0) {
                        updateDashboard();
                    }
                }, 500);
                return;
            }
            
            console.log('üìä updateDashboard chamado com', agendamentosData.length, 'agendamentos');
            console.log('üì¶ servicesData tem', servicesData.length, 'servi√ßos');
            
            const range = getPeriodRange(currentPeriod);
            let rev = 0; 
            const sMap = {};

            // Fun√ß√£o auxiliar: normaliza e contabiliza servi√ßos (suporta m√∫ltiplos servi√ßos por registro)
            function addServiceToMap(rawService) {
                let txt = (rawService || '').toString().trim();
                
                // Tratar vazio
                if (!txt) {
                    sMap['Outros'] = (sMap['Outros'] || 0) + 1;
                    console.debug('addServiceToMap: Servi√ßo vazio, adicionado como "Outros"');
                    return;
                }
                
                // Remover prefixos e textos desnecess√°rios
                txt = txt.replace(/^Venda:\s*/i, '').trim();

                // Remover sufixos entre par√™nteses como "(Assinatura)" ou "(Autismo)"
                txt = txt.replace(/\s*\([^)]*\)\s*/g, ' ').trim();

                // Separadores comuns -> suportar m√∫ltiplos servi√ßos em um √∫nico campo
                const parts = txt.split(/[;,\/\|\+]/).map(p => p.trim()).filter(Boolean);
                
                parts.forEach(p => {
                    if (!p) { sMap['Outros'] = (sMap['Outros'] || 0) + 1; return; }

                    // Tentativa de casar com servi√ßos cadastrados (normalizar pelo nome)
                    let key = 'Outros';
                    const pLower = p.toLowerCase();
                    
                    // PRIMEIRA PRIORIDADE: Casar com servicesData do banco
                    if (servicesData && Array.isArray(servicesData) && servicesData.length > 0) {
                        const matched = servicesData.find(s => {
                            const nameLower = (s.name || '').toString().toLowerCase();
                            return nameLower === pLower || 
                                   nameLower.includes(pLower) || 
                                   pLower.includes(nameLower);
                        });
                        if (matched) {
                            key = matched.name;
                        }
                    }
                    
                    // FALLBACK: Heur√≠sticas se ainda est√° como "Outros"
                    if (key === 'Outros') {
                        if (/combo completo/i.test(p)) key = 'Combo Completo: Cabelo, Barba e Sombrancelha';
                        else if (/combo.*corte.*barba/i.test(p) || /corte.*barba/i.test(p)) key = 'Combo Corte + Barba';
                        else if (/^combo/i.test(p)) key = 'Combos';
                        else if (/corte infantil/i.test(p)) key = 'Corte Infantil';
                        else if (/corte masculino/i.test(p)) key = 'Corte Masculino';
                        else if (/barba/i.test(p)) key = 'Barba Completa';
                        else if (/cortesia/i.test(p)) key = 'Cortesia';
                        else if (/bloqueio/i.test(p)) key = 'Bloqueio';
                        else if (/assinatura/i.test(p)) key = 'Assinatura';
                        else key = p; // Usar o nome original se n√£o combinar com nada
                    }

                    sMap[key] = (sMap[key] || 0) + 1;
                });
            }

            // Adicionar servi√ßos conclu√≠dos (excluindo assinaturas)
            agendamentosData.forEach(a => { 
                const status = (a.status || '').toString().toLowerCase();
                const ownerName = (a.nome || a.cliente || '').toString().trim();
                const isBlocked = ownerName.toUpperCase() === 'BLOQUEADO';
                if(status === 'completed' && !isBlocked && !a.isSubscription) {
                    const dt = a.data ? new Date(a.data + 'T00:00:00') : null;
                    if (dt && dt >= range.start && dt < range.end) {
                        rev += Number(a.preco || 0);
                        addServiceToMap(a.servico);
                    }
                }
            });

            // Adicionar vendas de produtos
            entradasData.forEach(e => {
                const dt = new Date(e.data + 'T00:00:00');
                if (dt >= range.start && dt < range.end) {
                    rev += Number(e.valor || 0);
                }
            });

            // ADICIONADO: Adicionar assinaturas pagas no per√≠odo
            if (subscriptionsData && Array.isArray(subscriptionsData)) {
                subscriptionsData.forEach(sub => {
                    if ((sub.paymentStatus || '').toString().toLowerCase() === 'paid' && sub.lastPaymentDate) {
                        const dt = new Date(sub.lastPaymentDate + 'T00:00:00');
                        if (dt >= range.start && dt < range.end) {
                            rev += Number(sub.value || 0);
                            addServiceToMap('Assinatura');
                        }
                    }
                });
            }

            let exp = 0; 
            if (despesasData && Array.isArray(despesasData)) {
                despesasData.forEach(e => {
                    const dt = new Date(e.data + 'T00:00:00');
                    if (dt >= range.start && dt < range.end) {
                        exp += Number(e.valor || 0);
                    }
                });
            }

            const profit = rev - exp;
            document.getElementById('dash-revenue').innerText = `R$ ${rev.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            const expEl = document.getElementById('dash-expense');
            expEl.innerText = `R$ ${exp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            const profitEl = document.getElementById('dash-profit');
            profitEl.innerText = `R$ ${profit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            profitEl.style.color = profit > 0 ? 'var(--success)' : (profit < 0 ? 'var(--danger)' : 'var(--text-muted)');
            
            console.log('üìà Mapa de servi√ßos para o gr√°fico:', Object.entries(sMap).map(([k, v]) => `${k}: ${v}`).join(', '));
            updateCharts(rev, exp, sMap);
        }

        function updateCharts(rev, exp, sMap) {
            console.log('üé® updateCharts chamado com:', { revenue: rev, expense: exp, services: sMap });
            const c1 = document.getElementById('mainChart')?.getContext('2d');
            if(c1) {
                if(mainChart) mainChart.destroy();
                mainChart = new Chart(c1, {
                    type: 'bar',
                    data: { 
                        labels: ['Faturamento', 'Custos'], 
                        datasets: [{ data: [rev, exp], backgroundColor: ['#1e90ff', '#ef4444'], barThickness: 50 }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            y: { 
                                grid: { color: '#333' }, 
                                ticks: { color: '#aaa', font: { size: 12 } }, 
                                beginAtZero: true 
                            }, 
                            x: { 
                                ticks: { color: '#aaa', font: { size: 12 } }, 
                                grid: { display: false } 
                            } 
                        } 
                    }
                });
            }

            const c2 = document.getElementById('pieChart')?.getContext('2d');
            if(c2) {
                const labels = Object.keys(sMap).sort((a, b) => {
                    const order = ["Corte Masculino", "Barba Completa", "Combo Corte + Barba", "Combo Completo: Cabelo, Barba e Sombrancelha", "Combos", "Corte Infantil", "Cortesia", "Bloqueio", "Assinatura", "Outros"];
                    const indexA = order.findIndex(o => a === o);
                    const indexB = order.findIndex(o => b === o);
                    return (indexA === -1 ? 99 : indexA) - (indexB === -1 ? 99 : indexB);
                });
                
                const data = labels.map(label => sMap[label]);
                // Filtrar servi√ßos com valor > 0 para melhor visualiza√ß√£o
                const filteredIndices = data.map((val, idx) => val > 0 ? idx : -1).filter(idx => idx !== -1);
                const filteredLabels = filteredIndices.map(idx => labels[idx]);
                const filteredData = filteredIndices.map(idx => data[idx]);
                const labelsWithValues = filteredLabels.map((label, index) => `${label}: ${filteredData[index]}`);

                const backgroundColors = filteredLabels.map(label => {
                    const cleanLabel = label.replace("Venda: ", "");
                    return serviceColors[cleanLabel] || serviceColors["Outros"];
                });

                if(pieChart) pieChart.destroy();
                pieChart = new Chart(c2, {
                    type: 'doughnut',
                    data: { 
                        labels: labelsWithValues, 
                        datasets: [{ 
                            data: filteredData, 
                            backgroundColor: backgroundColors, 
                            borderWidth: 0 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'right',
                                labels: { 
                                    color: '#aaa', 
                                    boxWidth: 10, 
                                    font: { size: 11 },
                                    padding: 10
                                } 
                            } 
                        } 
                    }
                });
            }
        }

        function renderClients() {
            const b = document.getElementById('list-clients'); 
            if(!b) return; 
            b.innerHTML = '';
            const m = {}; 
            
            agendamentosData.filter(a => (a.nome || a.cliente) && ((a.nome || a.cliente) !== 'BLOQUEADO')).forEach(a => {
                const nome = a.nome || a.cliente;
                const fone = (a.telefone || '').trim();
                const email = (a.email || '').trim();
                const uniqueKey = `${nome.toLowerCase()}_${fone}_${email.toLowerCase()}`;

                if(!m[uniqueKey]) {
                    m[uniqueKey] = { 
                        nome: nome, contato: fone, email: email, last: a.data, total: 0, count: 0 
                    };
                }
                
                if(a.status === 'completed') {
                    m[uniqueKey].total += Number(a.preco || 0); 
                    m[uniqueKey].count++;
                    if(new Date(a.data) > new Date(m[uniqueKey].last)) {
                        m[uniqueKey].last = a.data;
                    }
                }
            });

            Object.keys(m).sort((a, b) => { 
                return sortClientsByInactivity
                    ? new Date(m[a].last) - new Date(m[b].last)
                    : new Date(m[b].last) - new Date(m[a].last);
            }).forEach(k => {
                const c = m[k];
                const lastDate = new Date(c.last + 'T00:00:00'); 
                const diffDays = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24)); 

                const btnWhatsapp = c.contato 
                    ? `<button class="btn-action" style="padding:6px 12px;font-size:0.8rem" onclick="notifyInactive('${c.nome}','${c.contato}',${diffDays})">üì≤ Avisar</button>`
                    : '-';

                b.innerHTML += `
                    <tr>
                        <td><b>${c.nome}</b></td>
                        <td>
                            <div style="font-size:0.85rem; color:var(--text-muted)">${c.contato || 'Sem Telefone'}</div>
                            <div style="font-size:0.8rem; color:var(--primary)">${c.email || ''}</div>
                        </td>
                        <td style="font-size:0.9rem;">${c.last.split('-').reverse().join('/')}</td>
                        <td style="color:var(--primary); font-size:0.9rem;">R$ ${c.total.toFixed(2)}</td>
                        <td style="font-size:0.9rem;">${diffDays} dias</td>
                        <td>${btnWhatsapp}</td>
                    </tr>`;
            });
            lucide.createIcons();
        }

        window.switchFinanceMode = (mode) => {
            financeMode = mode;
            const btnDesp = document.getElementById('toggle-despesas');
            const btnEntr = document.getElementById('toggle-entradas');
            const btnRel = document.getElementById('toggle-relatorios');
            const sectionForm = document.getElementById('section-finance-form');
            const sectionTable = document.getElementById('section-finance-table');
            const sectionRel = document.getElementById('section-relatorios');

            if(mode === 'despesas') {
                btnDesp.classList.add('active');
                btnEntr.classList.remove('active');
                btnRel.classList.remove('active');
                sectionForm.style.display = 'block';
                sectionTable.style.display = 'block';
                sectionRel.style.display = 'none';
                document.getElementById('finance-form-title').innerText = 'Lan√ßar Nova Despesa';
                document.getElementById('label-total-filtrado').innerText = 'Total Despesas';
                document.getElementById('quick-products-container').style.display = 'none';
            } else if(mode === 'entradas') {
                btnEntr.classList.add('active');
                btnDesp.classList.remove('active');
                btnRel.classList.remove('active');
                sectionForm.style.display = 'block';
                sectionTable.style.display = 'block';
                sectionRel.style.display = 'none';
                document.getElementById('finance-form-title').innerText = 'Lan√ßar Venda de Produto';
                document.getElementById('label-total-filtrado').innerText = 'Total Vendas';
                document.getElementById('quick-products-container').style.display = 'block';
            } else if(mode === 'relatorios') {
                btnRel.classList.add('active');
                btnDesp.classList.remove('active');
                btnEntr.classList.remove('active');
                sectionForm.style.display = 'none';
                sectionTable.style.display = 'none';
                sectionRel.style.display = 'block';
            }
            
            // Renderizar tabela apropriada
            renderFinanceTable();
        };

        window.quickAdd = async (cat) => {
            const valor = parseFloat(document.getElementById('exp-val').value);
            const data = document.getElementById('exp-date').value;
            if(isNaN(valor) || !data) {
                showToast('Insira o valor da venda e a data', 'warning');
                return;
            }

            try {
                await addDoc(collection(db, 'entradas_produtos'), { 
                    descricao: cat, valor, data, category: cat, timestamp: new Date() 
                });
                document.getElementById('exp-val').value = '';
                showToast('Venda registrada com sucesso!', 'success');
            } catch(e) { 
                showToast('Erro: ' + e.message, 'error');
            }
        };

        window.addFinanceRecord = async (isPaid) => {
            const desc = document.getElementById('exp-desc').value;
            const valor = parseFloat(document.getElementById('exp-val').value);
            const data = document.getElementById('exp-date').value;
            const recurrence = document.getElementById('exp-recurrence').value;
            const category = document.getElementById('exp-category').value;

            if(isNaN(valor) || !data) {
                showToast('Preencha os campos obrigat√≥rios.', 'warning');
                return;
            }

            const collectionName = financeMode === 'despesas' ? 'despesas' : 'entradas_produtos';
            const payload = { 
                descricao: financeMode === 'despesas' ? desc : category, 
                valor, data, category, timestamp: new Date() 
            };
            if(financeMode === 'despesas') {
                payload.recurrence = recurrence;
                payload.pago = isPaid;
            }

            try {
                await addDoc(collection(db, collectionName), payload);
                document.getElementById('exp-desc').value = '';
                document.getElementById('exp-val').value = '';
                showToast(financeMode === 'despesas' ? 'Despesa registrada!' : 'Venda registrada!', 'success');
            } catch(e) { 
                showToast('Erro ao salvar: ' + e.message, 'error');
            }
        };

        window.togglePaidStatus = async (id, currentStatus) => {
            try {
                await updateDoc(doc(db, "despesas", id), { pago: !currentStatus });
                showToast(`Status alterado para ${!currentStatus ? 'PAGO' : 'PENDENTE'}`, 'success');
            } catch(e) {
                showToast('Erro ao alterar status: ' + e.message, 'error');
            }
        };

        window.deleteFinanceRecord = async (id) => {
            if(confirm('Excluir este registro permanentemente?')) {
                try {
                    const coll = financeMode === 'despesas' ? 'despesas' : 'entradas_produtos';
                    await deleteDoc(doc(db, coll, id));
                    showToast('Registro exclu√≠do com sucesso!', 'info');
                } catch(e) {
                    showToast('Erro ao excluir: ' + e.message, 'error');
                }
            }
        };

        window.renderFinanceTable = () => {
            const b = document.getElementById('list-finance');
            const catFilter = document.getElementById('filter-category').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            const data = financeMode === 'despesas' ? [...despesasData] : [...entradasData];
            
            b.innerHTML = '';
            let total = 0;
            const rMap = { weekly: 'Semanal', monthly: 'Mensal', yearly: 'Anual' };

            const filteredData = data.filter(item => {
                const matchesCat = catFilter === 'all' || item.category === catFilter;
                const matchesSearch = (item.descricao || '').toLowerCase().includes(searchFilter);
                return matchesCat && matchesSearch;
            });

            filteredData.sort((a, b) => {
                let valA, valB;
                const col = financeSort.column;
                const dir = financeSort.direction === 'asc' ? 1 : -1;
                if (col === 'valor') { valA = Number(a.valor || 0); valB = Number(b.valor || 0); }
                else if (col === 'data') { valA = a.data || ''; valB = b.data || ''; }
                else if (col === 'recurrence') { valA = a.recurrence || ''; valB = b.recurrence || ''; }
                else if (col === 'category') { valA = a.category || ''; valB = b.category || ''; }
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });

            filteredData.forEach(item => {
                const v = Number(item.valor || 0);
                total += v;
                const rLabel = item.recurrence ? (rMap[item.recurrence] || item.recurrence) : '-';
                let statusHtml = '';
                let actionsHtml = '';

                if (financeMode === 'despesas') {
                    const isPaid = item.pago === true;
                    statusHtml = `<td><span class="status-badge ${isPaid ? 'status-pago' : 'status-pendente'}">${isPaid ? 'Pago' : 'Pendente'}</span></td>`;
                    actionsHtml = `<button class="btn-action" style="background:none; color:${isPaid ? 'var(--warn)' : 'var(--success)'}; padding:0; min-width: auto;" onclick="togglePaidStatus('${item.id}', ${isPaid})" title="${isPaid ? 'Marcar como Pendente' : 'Marcar como Pago'}"><i data-lucide="${isPaid ? 'rotate-ccw' : 'check-circle-2'}"></i></button>`;
                } else {
                    statusHtml = '<td>-</td>';
                }

                b.innerHTML += `<tr>
                    <td style="font-size:0.9rem;">${item.data.split('-').reverse().join('/')}</td>
                    <td class="col-recurrence" style="${financeMode === 'entradas' ? 'display:none' : ''}; font-size:0.85rem;">
                        <span style="opacity: 0.7">${rLabel}</span>
                    </td>
                    <td>
                        <span style="background: #1a1a1a; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border); display: inline-block;">
                            ${item.category || 'Outros'}
                        </span>
                    </td>
                    <td style="font-size:0.9rem;">${item.descricao || ''}</td>
                    ${statusHtml}
                    <td style="color:${financeMode === 'despesas' ? 'var(--warn)' : 'var(--success)'}; font-size:0.9rem;">
                        R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits:2})}
                    </td>
                    <td style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                        ${actionsHtml}
                        <button class="btn-action" style="background:none; color:var(--danger); padding:0; min-width: auto;" onclick="deleteFinanceRecord('${item.id}')">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </td>
                </tr>`;
            });

            document.getElementById('filtered-total').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            lucide.createIcons();
        };

        const adminSubscriptionPlans = {
            'sempre-alinhado': { name: 'Sempre Alinhado', price: 79.90, frequency: 'monthly' },
            'combo-executivo': { name: 'Combo Executivo', price: 119.90, frequency: 'monthly' },
            'vip-premium': { name: 'VIP Premium', price: 159.90, frequency: 'monthly' }
        };

        window.updatePlanDetails = () => {
            const planId = document.getElementById('sub-service').value;
            const valueInput = document.getElementById('sub-value');
            if (planId && adminSubscriptionPlans[planId]) valueInput.value = adminSubscriptionPlans[planId].price;
            else valueInput.value = '';
        };

        window.addSubscription = async () => {
            const client = document.getElementById('sub-client').value.trim();
            const telefone = document.getElementById('sub-phone').value.trim();
            const planId = document.getElementById('sub-service').value;
            const value = parseFloat(document.getElementById('sub-value').value);
            const startDate = document.getElementById('sub-start-date').value;
            const status = document.getElementById('sub-status').value;

            if (!client || !planId || !value || !startDate) {
                showToast('Preencha os campos obrigat√≥rios!', 'warning');
                return;
            }

            const plan = adminSubscriptionPlans[planId];
            const nextBilling = new Date(startDate);
            nextBilling.setMonth(nextBilling.getMonth() + 1);

            try {
                await addDoc(collection(db, "assinaturas"), {
                    client, telefone, plan: planId, planName: plan.name, frequency: plan.frequency,
                    value, startDate, nextBilling: nextBilling.toISOString().split('T')[0], status, createdAt: new Date()
                });

                document.getElementById('sub-client').value = '';
                document.getElementById('sub-phone').value = '';
                document.getElementById('sub-service').value = '';
                document.getElementById('sub-value').value = '';
                showToast('Assinatura adicionada com sucesso!', 'success');
            } catch(e) {
                showToast('Erro ao adicionar assinatura: ' + e.message, 'error');
            }
        };

        window.toggleSubscriptionStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            try {
                await updateDoc(doc(db, "assinaturas", id), { status: newStatus });
                showToast(`Assinatura ${newStatus === 'active' ? 'ativada' : 'desativada'}!`, 'success');
            } catch(e) {
                showToast('Erro ao alterar status: ' + e.message, 'error');
            }
        };

        // --- NOVA FUN√á√ÉO PARA PAGAMENTO DE ASSINATURA ---
        window.toggleSubscriptionPayment = async (id, currentStatus) => {
            const newStatus = currentStatus === 'paid' ? 'pending' : 'paid';
            try {
                // Atualiza apenas o status de pagamento
                await updateDoc(doc(db, "assinaturas", id), { 
                    paymentStatus: newStatus,
                    lastPaymentDate: newStatus === 'paid' ? new Date().toISOString().split('T')[0] : null
                });
                showToast(`Pagamento marcado como ${newStatus === 'paid' ? 'PAGO' : 'PENDENTE'}`, 'success');
            } catch(e) {
                showToast('Erro ao atualizar pagamento: ' + e.message, 'error');
            }
        };

        window.deleteSubscription = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta assinatura?')) {
                try {
                    await deleteDoc(doc(db, "assinaturas", id));
                    showToast('Assinatura exclu√≠da com sucesso!', 'info');
                } catch(e) {
                    showToast('Erro ao excluir: ' + e.message, 'error');
                }
            }
        };

        window.sendPaymentRequest = (clientName, telefone, amount) => {
            if(!telefone) {
                telefone = prompt("Telefone n√£o encontrado. Digite o WhatsApp do cliente (com DDD):", "2899");
                if(!telefone) return;
            }
            const clean = telefone.toString().replace(/\D/g, "");
            const fullPhone = clean.startsWith("55") ? clean : "55" + clean;
            const msg = encodeURIComponent(
                `Ol√°, ${clientName}! üëã\n\n` +
                `Estou passando para lembr√°-lo da sua assinatura na *${window.barberName || 'FLOW BARBER'}*! ‚úÇÔ∏è\n\n` +
                `Valor: *R$ ${amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}*\n` +
                `PIX: *28999082741*\n\n` +
                `Pode nos enviar o comprovante ap√≥s o pagamento? üòâ`
            );
            window.open(`https://api.whatsapp.com/send?phone=${fullPhone}&text=${msg}`);
        };

        // --- FUN√á√ÉO ATUALIZADA PARA MOSTRAR STATUS DE PAGAMENTO ---
        function renderSubscriptions() {
            const tbody = document.getElementById('list-subscriptions');
            if (!tbody) return;

            // Ordena para mostrar ativos primeiro
            const sortedSubs = [...subscriptionsData].sort((a, b) => (a.status === 'active' ? -1 : 1));

            tbody.innerHTML = sortedSubs.map(sub => {
                const statusBadge = sub.status === 'active' 
                    ? '<span class="status-badge status-pago">Ativa</span>' 
                    : '<span class="status-badge status-pendente">Inativa</span>';
                
                // L√≥gica do Pagamento
                const isPaid = sub.paymentStatus === 'paid';
                const paymentBadge = isPaid
                    ? '<span class="status-badge status-pago" style="font-size: 0.7rem;">PAGO ‚úÖ</span>'
                    : '<span class="status-badge status-pendente" style="font-size: 0.7rem; background: rgba(239, 68, 68, 0.2); color: var(--danger);">PENDENTE ‚è≥</span>';

                // Calcular uso dos servi√ßos
                const usedServices = sub.usedServices || 0;
                let totalServices;
                if (sub.plan === 'sempre-alinhado') totalServices = 7; // 4 Pezinhos + 2 Barbas + 1 Sobrancelha
                else if (sub.plan === 'combo-executivo') totalServices = 4; // 2 Cortes + 2 Barbas (sobrancelha ilimitada)
                else if (sub.plan === 'vip-premium') totalServices = Infinity; // ilimitado
                else totalServices = 12; // fallback
                const usagePercentage = (usedServices / totalServices) * 100;
                const isNearLimit = usagePercentage >= 75;
                
                // Barra de progresso de uso
                const progressBar = totalServices === Infinity ? `
                    <div style="font-size: 0.8rem; color: var(--success); margin-top: 5px;">
                        Servi√ßos ilimitados
                    </div>
                ` : `
                    <div class="subscription-progress">
                        <div class="subscription-progress-bar" style="width: ${Math.min((usedServices / totalServices) * 100, 100)}%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                        ${usedServices}/${totalServices} servi√ßos
                    </div>
                `;

                // Alerta de uso pr√≥ximo ao limite
                const usageAlert = (totalServices !== Infinity && usagePercentage >= 75) ? `
                    <div class="subscription-alert">
                        ‚ö†Ô∏è ${sub.client} est√° pr√≥ximo do limite! (${usedServices}/${totalServices} servi√ßos)
                    </div>
                ` : '';

                const targetPhone = (sub.clientPhone || sub.telefone || sub.phone || '').toString();
                const escapedClient = (sub.client || '').replace(/'/g, "\\'");

                return `
                    ${usageAlert}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="client-avatar">${(sub.client || '').charAt(0).toUpperCase()}</div>
                                <div>
                                    <b>${sub.client}</b>
                                    ${progressBar}
                                </div>
                            </div>
                        </td>
                        <td style="font-size:0.9rem;">${targetPhone || '-'}</td>
                        <td style="font-size:0.9rem;">${sub.planName}</td>
                        <td style="color:var(--primary); font-size:0.9rem;">R$ ${sub.value.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                        <td style="font-size:0.9rem;">${sub.startDate.split('-').reverse().join('/')}</td>
                        <td style="font-size:0.9rem;">${sub.nextBilling.split('-').reverse().join('/')}</td>
                        <td>${statusBadge}<br><div style="margin-top:5px; cursor:pointer;" onclick="toggleSubscriptionPayment('${sub.id}', '${sub.paymentStatus}')">${paymentBadge}</div></td>
                        <td style="text-align: right;">
                            <div class="action-buttons">
                                <button class="btn-action" style="background: #25d366; padding: 8px 12px; font-size:0.85rem;" onclick="sendPaymentRequest('${escapedClient}', '${targetPhone}', ${sub.value})">
                                    <i data-lucide="message-circle"></i>
                                </button>
                                <button class="btn-action" style="background: var(--primary); padding: 8px 12px; font-size:0.85rem;" onclick="toggleSubscriptionStatus('${sub.id}', '${sub.status}')">
                                    ${sub.status === 'active' ? 'Desativar' : 'Ativar'}
                                </button>
                                <button class="btn-action" style="background: var(--danger); padding: 8px 12px; font-size:0.85rem;" onclick="deleteSubscription('${sub.id}')">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
            lucide.createIcons();
        }

        // Fun√ß√£o auxiliar para verificar se um agendamento √© por assinatura
        function isSubscriptionBooking(booking) {
            return booking && booking.isSubscription === true;
        }

        // Fun√ß√£o para calcular receita excluindo agendamentos por assinatura
        function calculateRevenueExcludingSubscriptions(bookings, startDate, endDate) {
            let totalRevenue = 0;
            
            bookings.forEach(booking => {
                if (booking.status === 'completed' && 
                    booking.data && 
                    !isSubscriptionBooking(booking) && 
                    (booking.nome || booking.cliente) !== 'BLOQUEADO') {
                    
                    const bookingDate = new Date(booking.data + 'T00:00:00');
                    if (bookingDate >= startDate && bookingDate <= endDate) {
                        totalRevenue += Number(booking.preco || 0);
                    }
                }
            });
            
            return totalRevenue;
        }

        // Fun√ß√£o para renderizar hist√≥rico de uso das assinaturas
        function renderSubscriptionUsageHistory() {
            const tbody = document.getElementById('subscription-usage-history');
            if (!tbody) return;

            // Filtrar agendamentos por assinatura dos √∫ltimos 30 dias
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const subscriptionBookings = agendamentosData
                .filter(a => a.isSubscription && a.data && new Date(a.data + 'T00:00:00') >= thirtyDaysAgo)
                .sort((a, b) => new Date(b.data + 'T00:00:00') - new Date(a.data + 'T00:00:00'));

            tbody.innerHTML = subscriptionBookings.map(booking => {
                // Encontrar a assinatura correspondente
                const subscription = subscriptionsData.find(sub => 
                    sub.client === (booking.nome || booking.cliente) && 
                    sub.status === 'active'
                );

                const planName = subscription ? 
                    (subscription.plan === 'sempre-alinhado' ? 'Sempre Alinhado' : 
                     subscription.plan === 'combo-executivo' ? 'Combo Executivo' : 'VIP Premium') : 
                    'N/A';

                const statusBadge = booking.status === 'completed' 
                    ? '<span class="status-badge status-pago">Conclu√≠do</span>' 
                    : booking.status === 'confirmed' 
                    ? '<span class="status-badge status-pendente">Confirmado</span>'
                    : '<span class="status-badge" style="background: var(--text-muted);">Agendado</span>';

                return `<tr>
                    <td style="font-size:0.9rem;">${booking.data.split('-').reverse().join('/')}</td>
                    <td><b>${booking.nome || booking.cliente || 'N/A'}</b></td>
                    <td style="font-size:0.9rem;">${booking.servico || 'N/A'}</td>
                    <td style="font-size:0.9rem;">${planName}</td>
                    <td style="font-size:0.9rem; color: var(--subscription); font-weight: bold;">#${booking.subscriptionUseNumber || 1}</td>
                    <td>${statusBadge}</td>
                </tr>`;
            }).join('');

            if (subscriptionBookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">Nenhum uso de assinatura nos √∫ltimos 30 dias</td></tr>';
            }

            lucide.createIcons();
        };

        const serviceOrder = [
            "Cabelo na Maquina",
            "Cabelo s√≥ tesoura", 
            "Corte Infantil",
            "Pezinho",
            "Combo Corte + Barba",
            "Combo Completo: Cabelo, Barba e Sobrancelha",
            "Pezinho",
            "Sobrancelha",
            "Pigmenta√ß√£o",
            "Depila√ß√£o Nariz/Orelha"
        ];

        // --- FUN√á√ÉO ATUALIZADA PARA ORDENA√á√ÉO DE SERVI√áOS COM DESCRI√á√ÉO ---
        window.renderServices = () => {
    const tbody = document.getElementById('list-services');
    if (!tbody) {
        console.error('Elemento list-services n√£o encontrado');
        return;
    }

    tbody.innerHTML = '';

    // Ordenar servi√ßos por nome
    const servicosOrdenados = [...servicesData].sort((a, b) => a.name.localeCompare(b.name));

    if (servicosOrdenados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem;">
                    Nenhum servi√ßo cadastrado. Adicione seu primeiro servi√ßo acima.
                </td>
            </tr>
        `;
        return;
    }

    servicosOrdenados.forEach(servico => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${servico.name}</strong></td>
            <td style="color: var(--primary)">R$ ${servico.price.toFixed(2)}</td>
            <td>${servico.duration} min</td>
            <td>${Math.ceil(servico.duration / 30)} slot(s)</td>
            <td>${servico.description || '-'}</td>
            <td style="display: flex; gap: 8px;">
                <button class="btn-action" style="background: var(--primary); padding: 6px 12px; font-size: 0.8rem;" onclick="editarServico('${servico.id}')">
                    <i data-lucide="edit-2"></i> Editar
                </button>
                <button class="btn-action" style="background: var(--danger); padding: 6px 12px; font-size: 0.8rem;" onclick="excluirServico('${servico.id}')">
                    <i data-lucide="trash-2"></i> Excluir
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    lucide.createIcons();
};

// Salvar servi√ßo (criar ou atualizar) com descri√ß√£o
window.salvarServico = async () => {
    const nome = document.getElementById('servico-nome').value;
    const preco = parseFloat(document.getElementById('servico-preco').value);
    const duracao = parseInt(document.getElementById('servico-duracao').value);
    const slots = parseInt(document.getElementById('servico-slots').value);
    const descricao = document.getElementById('servico-descricao').value;
    const servicoId = document.getElementById('servico-id-editando').value;

    if (!nome || isNaN(preco) || isNaN(duracao) || isNaN(slots)) {
        showToast('Preencha todos os campos obrigat√≥rios corretamente.', 'warning');
        return;
    }

    // Garantir que a dura√ß√£o seja m√∫ltiplo de 30
    if (duracao % 30 !== 0) {
        showToast('A dura√ß√£o deve ser m√∫ltipla de 30 minutos.', 'warning');
        return;
    }

    // Garantir que os slots correspondam √† dura√ß√£o (cada slot = 30min)
    const slotsCalculados = Math.ceil(duracao / 30);
    if (slots !== slotsCalculados) {
        if (confirm(`A dura√ß√£o de ${duracao} minutos corresponde a ${slotsCalculados} slot(s). Deseja ajustar automaticamente?`)) {
            document.getElementById('servico-slots').value = slotsCalculados;
            slots = slotsCalculados;
        }
    }

    const servicoData = {
        name: nome,
        price: preco,
        duration: duracao,
        slots: slots,
        description: descricao,
        timestamp: new Date()
    };

    try {
        if (servicoId) {
            // Atualizar servi√ßo existente
            await updateDoc(doc(db, "services", servicoId), servicoData);
            showToast('Servi√ßo atualizado com sucesso!', 'success');
        } else {
            // Criar novo servi√ßo
            await addDoc(collection(db, "services"), servicoData);
            showToast('Servi√ßo criado com sucesso!', 'success');
        }

        // Limpar formul√°rio
        document.getElementById('servico-nome').value = '';
        document.getElementById('servico-preco').value = '';
        document.getElementById('servico-duracao').value = '30';
        document.getElementById('servico-slots').value = '1';
        document.getElementById('servico-descricao').value = '';
        document.getElementById('servico-id-editando').value = '';
        document.getElementById('btn-cancelar-edicao').style.display = 'none';

    } catch (e) {
        showToast('Erro ao salvar servi√ßo: ' + e.message, 'error');
    }
};

// Editar servi√ßo com descri√ß√£o
window.editarServico = async (id) => {
    const servico = servicesData.find(s => s.id === id);
    if (!servico) return;

    document.getElementById('servico-nome').value = servico.name;
    document.getElementById('servico-preco').value = servico.price;
    document.getElementById('servico-duracao').value = servico.duration;
    document.getElementById('servico-slots').value = servico.slots || Math.ceil(servico.duration / 30);
    document.getElementById('servico-descricao').value = servico.description || '';
    document.getElementById('servico-id-editando').value = servico.id;
    document.getElementById('btn-cancelar-edicao').style.display = 'block';

    // Rolar para o formul√°rio
    document.getElementById('servico-nome').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('servico-nome').focus();

    showToast(`Editando: ${servico.name}`, 'info');
};

// Cancelar edi√ß√£o de servi√ßo
window.cancelarEdicaoServico = () => {
    document.getElementById('servico-nome').value = '';
    document.getElementById('servico-preco').value = '';
    document.getElementById('servico-duracao').value = '30';
    document.getElementById('servico-slots').value = '1';
    document.getElementById('servico-descricao').value = '';
    document.getElementById('servico-id-editando').value = '';
    document.getElementById('btn-cancelar-edicao').style.display = 'none';
    showToast('Edi√ß√£o cancelada.', 'info');
};

// Excluir servi√ßo
window.excluirServico = async (id) => {
    const servico = servicesData.find(s => s.id === id);
    if (!servico) return;

    if (!confirm(`Tem certeza que deseja excluir o servi√ßo "${servico.name}"?`)) {
        return;
    }

    // Verificar se o servi√ßo est√° sendo usado em agendamentos
    const agendamentosComServico = agendamentosData.filter(a =>
        a.servico && a.servico.includes(servico.name)
    );

    if (agendamentosComServico.length > 0) {
        if (!confirm(`Este servi√ßo est√° em ${agendamentosComServico.length} agendamento(s). A exclus√£o pode afetar esses registros. Deseja continuar?`)) {
            return;
        }
    }

    try {
        await deleteDoc(doc(db, "services", id));
        showToast('Servi√ßo exclu√≠do com sucesso!', 'success');
    } catch (e) {
        showToast('Erro ao excluir servi√ßo: ' + e.message, 'error');
    }
};

        // --- NOVAS FUN√á√ïES PARA PLANOS DE ASSINATURA ---
        
        // Renderizar servi√ßos no formul√°rio de assinatura
        function renderServicosAssinaturaForm() {
            const container = document.getElementById('assinatura-servicos-container');
            if (!container) return;

            if (!servicesData || servicesData.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">Nenhum servi√ßo cadastrado.</p>';
                return;
            }

            container.innerHTML = '';
            servicesData.forEach(service => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 12px; background: #111111; border: 1px solid var(--border); border-radius: 8px;';
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <input type="checkbox" id="service-${service.id}" data-service-id="${service.id}" data-service-name="${service.name}" style="width: 18px; height: 18px; cursor: pointer;">
                        <label for="service-${service.id}" style="flex: 1; cursor: pointer; margin: 0;">${service.name}</label>
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Quantidade m√°xima/m√™s:</label>
                        <input type="number" class="service-quantity" data-service-id="${service.id}" min="1" value="1" style="width: 100%; padding: 6px; background: #0a0a0a; border: 1px solid var(--border); color: #fff; border-radius: 4px;" disabled>
                    </div>
                `;
                container.appendChild(div);

                const checkbox = div.querySelector('input[type="checkbox"]');
                const quantityInput = div.querySelector('.service-quantity');
                
                checkbox.addEventListener('change', () => {
                    quantityInput.disabled = !checkbox.checked;
                });
            });
        }

        // Renderizar planos de assinatura
        function renderSubscriptionPlans() {
            const tbody = document.getElementById('list-services-assinatura');
            if (!tbody) {
                console.error('Elemento list-services-assinatura n√£o encontrado');
                return;
            }

            tbody.innerHTML = '';

            if (subscriptionPlansData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem;">
                            Nenhum plano de assinatura cadastrado. Adicione seu primeiro plano acima.
                        </td>
                    </tr>
                `;
                return;
            }

            subscriptionPlansData.forEach(plano => {
                const frequenciaMap = {
                    'monthly': 'Mensal',
                    'quarterly': 'Trimestral',
                    'semiannual': 'Semestral',
                    'annual': 'Anual'
                };

                // Formatar servi√ßos inclusos
                let servicosDisplay = '-';
                if (plano.servicesIncluded && Array.isArray(plano.servicesIncluded) && plano.servicesIncluded.length > 0) {
                    servicosDisplay = plano.servicesIncluded.map(s => `${s.name} (${s.maxPerMonth}x)`).join(', ');
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${plano.name}</strong></td>
                    <td style="color: var(--primary)">R$ ${plano.price.toFixed(2)}</td>
                    <td>${frequenciaMap[plano.frequency] || plano.frequency}</td>
                    <td>${plano.description || '-'}</td>
                    <td style="font-size: 0.85rem; color: var(--text-muted);">${servicosDisplay}</td>
                    <td style="display: flex; gap: 8px;">
                        <button class="btn-action" style="background: var(--primary); padding: 6px 12px; font-size: 0.8rem;" onclick="editarServicoAssinatura('${plano.id}')">
                            <i data-lucide="edit-2"></i> Editar
                        </button>
                        <button class="btn-action" style="background: var(--danger); padding: 6px 12px; font-size: 0.8rem;" onclick="excluirServicoAssinatura('${plano.id}')">
                            <i data-lucide="trash-2"></i> Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            lucide.createIcons();
        }

        // Salvar plano de assinatura
        window.salvarServicoAssinatura = async () => {
            const nome = document.getElementById('assinatura-nome').value;
            const valor = parseFloat(document.getElementById('assinatura-valor').value);
            const frequencia = document.getElementById('assinatura-frequencia').value;
            const descricao = document.getElementById('assinatura-descricao').value;
            const assinaturaId = document.getElementById('assinatura-id-editando').value;

            if (!nome || isNaN(valor)) {
                showToast('Preencha todos os campos obrigat√≥rios corretamente.', 'warning');
                return;
            }

            // Coletar servi√ßos selecionados
            const servicesIncluded = [];
            const checkboxes = document.querySelectorAll('#assinatura-servicos-container input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                const serviceId = checkbox.dataset.serviceId;
                const serviceName = checkbox.dataset.serviceName;
                const quantity = parseInt(document.querySelector(`.service-quantity[data-service-id="${serviceId}"]`).value);
                servicesIncluded.push({
                    id: serviceId,
                    name: serviceName,
                    maxPerMonth: quantity
                });
            });

            const planoData = {
                name: nome,
                price: valor,
                frequency: frequencia,
                description: descricao,
                servicesIncluded: servicesIncluded,
                timestamp: new Date()
            };

            try {
                if (assinaturaId) {
                    // Atualizar plano existente
                    await updateDoc(doc(db, "subscription_plans", assinaturaId), planoData);
                    showToast('Plano de assinatura atualizado com sucesso!', 'success');
                } else {
                    // Criar novo plano
                    await addDoc(collection(db, "subscription_plans"), planoData);
                    showToast('Plano de assinatura criado com sucesso!', 'success');
                }

                // Limpar formul√°rio
                document.getElementById('assinatura-nome').value = '';
                document.getElementById('assinatura-valor').value = '';
                document.getElementById('assinatura-frequencia').value = 'monthly';
                document.getElementById('assinatura-descricao').value = '';
                document.getElementById('assinatura-id-editando').value = '';
                document.getElementById('btn-cancelar-edicao-assinatura').style.display = 'none';
                
                // Limpar sele√ß√£o de servi√ßos
                document.querySelectorAll('#assinatura-servicos-container input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('.service-quantity').forEach(input => input.disabled = true);

            } catch (e) {
                showToast('Erro ao salvar plano de assinatura: ' + e.message, 'error');
            }
        };

        // Editar plano de assinatura
        window.editarServicoAssinatura = async (id) => {
            const plano = subscriptionPlansData.find(p => p.id === id);
            if (!plano) return;

            document.getElementById('assinatura-nome').value = plano.name;
            document.getElementById('assinatura-valor').value = plano.price;
            document.getElementById('assinatura-frequencia').value = plano.frequency;
            document.getElementById('assinatura-descricao').value = plano.description || '';
            document.getElementById('assinatura-id-editando').value = plano.id;
            document.getElementById('btn-cancelar-edicao-assinatura').style.display = 'block';

            // Renderizar servi√ßos e marcar os j√° selecionados
            renderServicosAssinaturaForm();
            if (plano.servicesIncluded && Array.isArray(plano.servicesIncluded)) {
                plano.servicesIncluded.forEach(service => {
                    const checkbox = document.querySelector(`#service-${service.id}`);
                    const quantityInput = document.querySelector(`.service-quantity[data-service-id="${service.id}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        quantityInput.disabled = false;
                        quantityInput.value = service.maxPerMonth || 1;
                    }
                });
            }

            // Rolar para o formul√°rio
            document.getElementById('assinatura-nome').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('assinatura-nome').focus();

            showToast(`Editando: ${plano.name}`, 'info');
        };

        // Cancelar edi√ß√£o de plano de assinatura
        window.cancelarEdicaoServicoAssinatura = () => {
            document.getElementById('assinatura-nome').value = '';
            document.getElementById('assinatura-valor').value = '';
            document.getElementById('assinatura-frequencia').value = 'monthly';
            document.getElementById('assinatura-descricao').value = '';
            document.getElementById('assinatura-id-editando').value = '';
            document.getElementById('btn-cancelar-edicao-assinatura').style.display = 'none';
            showToast('Edi√ß√£o cancelada.', 'info');
        };

        // Excluir plano de assinatura
        window.excluirServicoAssinatura = async (id) => {
            const plano = subscriptionPlansData.find(p => p.id === id);
            if (!plano) return;

            if (!confirm(`Tem certeza que deseja excluir o plano "${plano.name}"?`)) {
                return;
            }

            // Verificar se o plano est√° sendo usado em assinaturas
            const assinaturasComPlano = subscriptionsData.filter(sub =>
                sub.plan === plano.name || sub.planName === plano.name
            );

            if (assinaturasComPlano.length > 0) {
                if (!confirm(`Este plano est√° em ${assinaturasComPlano.length} assinatura(s). A exclus√£o pode afetar esses registros. Deseja continuar?`)) {
                    return;
                }
            }

            try {
                await deleteDoc(doc(db, "subscription_plans", id));
                showToast('Plano de assinatura exclu√≠do com sucesso!', 'success');
            } catch (e) {
                showToast('Erro ao excluir plano de assinatura: ' + e.message, 'error');
            }
        };

        // Preencher select de planos na aba de assinaturas
        function populateSubscriptionPlansSelect() {
            const select = document.getElementById('sub-service');
            if (!select) return;

            // Limpar op√ß√µes atuais, mantendo a primeira op√ß√£o
            select.innerHTML = '<option value="">Selecione um plano...</option>';

            // Adicionar planos do banco de dados
            subscriptionPlansData.forEach(plano => {
                const frequenciaMap = {
                    'monthly': '/m√™s',
                    'quarterly': '/trimestre',
                    'semiannual': '/semestre',
                    'annual': '/ano'
                };

                const option = document.createElement('option');
                option.value = plano.id; // Usar ID como valor
                option.textContent = `${plano.name} - R$ ${plano.price.toFixed(2)}${frequenciaMap[plano.frequency] || ''}`;
                select.appendChild(option);
            });
        }

        // Atualizar fun√ß√£o updatePlanDetails para usar os planos do banco
        window.updatePlanDetails = () => {
            const planId = document.getElementById('sub-service').value;
            const valueInput = document.getElementById('sub-value');
            
            // Encontrar o plano selecionado
            const planoSelecionado = subscriptionPlansData.find(p => p.id === planId);
            
            if (planoSelecionado) {
                valueInput.value = planoSelecionado.price;
            } else {
                valueInput.value = '';
            }
        };

        // Atualizar fun√ß√£o addSubscription para usar os planos do banco
        window.addSubscription = async () => {
            const client = document.getElementById('sub-client').value.trim();
            const telefone = document.getElementById('sub-phone').value.trim();
            const planId = document.getElementById('sub-service').value;
            const value = parseFloat(document.getElementById('sub-value').value);
            const startDate = document.getElementById('sub-start-date').value;
            const status = document.getElementById('sub-status').value;

            if (!client || !planId || !value || !startDate) {
                showToast('Preencha os campos obrigat√≥rios!', 'warning');
                return;
            }

            // Encontrar o plano selecionado
            const planoSelecionado = subscriptionPlansData.find(p => p.id === planId);
            if (!planoSelecionado) {
                showToast('Plano selecionado n√£o encontrado!', 'error');
                return;
            }

            const nextBilling = new Date(startDate);
            
            // Calcular pr√≥xima cobran√ßa baseado na frequ√™ncia
            if (planoSelecionado.frequency === 'monthly') {
                nextBilling.setMonth(nextBilling.getMonth() + 1);
            } else if (planoSelecionado.frequency === 'quarterly') {
                nextBilling.setMonth(nextBilling.getMonth() + 3);
            } else if (planoSelecionado.frequency === 'semiannual') {
                nextBilling.setMonth(nextBilling.getMonth() + 6);
            } else if (planoSelecionado.frequency === 'annual') {
                nextBilling.setFullYear(nextBilling.getFullYear() + 1);
            }

            try {
                await addDoc(collection(db, "assinaturas"), {
                    client, 
                    telefone, 
                    plan: planoSelecionado.name, // Usar o nome do plano
                    planName: planoSelecionado.name,
                    planId: planoSelecionado.id, // Salvar tamb√©m o ID do plano
                    frequency: planoSelecionado.frequency,
                    value, 
                    startDate, 
                    nextBilling: nextBilling.toISOString().split('T')[0], 
                    status, 
                    paymentStatus: 'pending', // Status de pagamento padr√£o
                    createdAt: new Date(),
                    usedServices: 0
                });

                // Limpar formul√°rio
                document.getElementById('sub-client').value = '';
                document.getElementById('sub-phone').value = '';
                document.getElementById('sub-service').value = '';
                document.getElementById('sub-value').value = '';
                document.getElementById('sub-start-date').value = '';
                
                showToast('Assinatura adicionada com sucesso!', 'success');
            } catch(e) {
                showToast('Erro ao adicionar assinatura: ' + e.message, 'error');
            }
        };

        function populateServiceSelect() {
    const serviceSelect = document.getElementById('edit-service');
    if (!serviceSelect) {
        console.error('Elemento edit-service n√£o encontrado');
        return;
    }

    // Limpar op√ß√µes atuais
    serviceSelect.innerHTML = '';

    // Verificar se servicesData existe e tem itens
    if (!servicesData || servicesData.length === 0) {
        console.warn('Nenhum servi√ßo dispon√≠vel em servicesData');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Carregando servi√ßos...';
        serviceSelect.appendChild(option);
        
        // Tentar recarregar ap√≥s 1 segundo
        setTimeout(() => {
            if (servicesData && servicesData.length > 0) {
                populateServiceSelect();
            }
        }, 1000);
        return;
    }

    console.log('Populando select com', servicesData.length, 'servi√ßos');

    // Ordenar servi√ßos de forma amig√°vel
    const sortedServices = [...servicesData].sort((a, b) => {
        const indexA = serviceOrder.indexOf(a.name);
        const indexB = serviceOrder.indexOf(b.name);
        
        if (indexA === -1 && indexB === -1) return 0;
        if (indexA === -1) return 1;
        if (indexB === -1) return -1;
        
        return indexA - indexB;
    });

    // Adicionar cada servi√ßo como uma op√ß√£o
    sortedServices.forEach(service => {
        if (!service.name) {
            console.warn('Servi√ßo sem nome:', service);
            return;
        }
        
        // Calcular quantos slots s√£o necess√°rios (30 min = 1 slot)
        const slotsNeeded = Math.ceil(service.duration / 30);
        
        // Formatar o texto da op√ß√£o
        const optionText = `${service.name} (R$ ${service.price} - ${service.duration}min)`;
        const optionValue = `${service.name}|${service.price}|${slotsNeeded}`;
        
        const option = document.createElement('option');
        option.value = optionValue;
        option.textContent = optionText;
        serviceSelect.appendChild(option);
    });

    // Adicionar a op√ß√£o de Cortesia (que n√£o est√° no banco de dados)
    const cortesiaOption = document.createElement('option');
    cortesiaOption.value = 'Cortesia|0|1';
    cortesiaOption.textContent = 'Cortesia (R$ 0)';
    serviceSelect.appendChild(cortesiaOption);

    console.log('Select de servi√ßos populado com sucesso');
}

        window.updateService = (id, field, value) => {
            const service = servicesData.find(s => s.id === id);
            if (service) {
                service[field] = field === 'price' ? parseFloat(value) : parseInt(value);
            }
        };

        window.saveService = async (id) => {
            const service = servicesData.find(s => s.id === id);
            if (!service) return;

            try {
                await updateDoc(doc(db, "services", id), {
                    duration: service.duration,
                    price: service.price
                });
                showToast('Servi√ßo atualizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar servi√ßo:', error);
                showToast('Erro ao salvar servi√ßo.', 'error');
            }
        };

        // --- FUN√á√ÉO ATUALIZADA PARA RELAT√ìRIO FISCAL COM ASSINATURAS ---
        window.generateFiscalReport = () => {
            // Verificar se a funcionalidade est√° habilitada
            if (!fiscalReportEnabled) {
                showToast('‚ùå Relat√≥rio fiscal est√° desabilitado. Converse com o administrador.', 'error');
                return;
            }
            
            // PROTE√á√ÉO: Garantir que os dados est√£o sincronizados
            if (!agendamentosData || !subscriptionsData || !entradasData) {
                console.warn('generateFiscalReport: Aguardando sincroniza√ß√£o de dados...');
                showToast('‚è≥ Sincronizando dados... Por favor, aguarde.', 'info');
                setTimeout(() => {
                    if (agendamentosData && subscriptionsData && entradasData) {
                        generateFiscalReport();
                    }
                }, 1000);
                return;
            }

            const year = document.getElementById('report-year').value;
            const month = document.getElementById('report-month').value;
            const week = document.getElementById('report-week').value;
            
            if (!year) {
                showToast('Por favor, selecione um ano.', 'warning');
                return;
            }

            let startStr = "";
            let endStr = "";
            let periodText = "";

            // Helper para formatar data YYYY-MM-DD
            const formatDateStr = (dateObj) => {
                const y = dateObj.getFullYear();
                const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                const d = String(dateObj.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            if (month && week) {
                // Filtro por semana espec√≠fica
                const weekNum = parseInt(week);
                const firstDayOfMonth = new Date(year, parseInt(month) - 1, 1);
                
                let startDt = new Date(firstDayOfMonth);
                
                if (weekNum === 1) startDt.setDate(1);
                else if (weekNum === 2) startDt.setDate(8);
                else if (weekNum === 3) startDt.setDate(15);
                else if (weekNum === 4) startDt.setDate(22);
                else if (weekNum === 5) startDt.setDate(29);

                let endDt = new Date(startDt);
                endDt.setDate(startDt.getDate() + 6);

                const lastDayOfMonth = new Date(year, parseInt(month), 0);
                if (endDt > lastDayOfMonth) endDt = lastDayOfMonth;
                if (startDt.getMonth() !== parseInt(month) - 1) startDt = lastDayOfMonth; 

                startStr = formatDateStr(startDt);
                endStr = formatDateStr(endDt);
                periodText = `Semana ${week} de ${getMonthName(month)}/${year}`;
                
            } else if (month) {
                // Filtro por m√™s inteiro
                const lastDay = new Date(year, parseInt(month), 0).getDate();
                startStr = `${year}-${month}-01`;
                endStr = `${year}-${month}-${String(lastDay).padStart(2,'0')}`;
                periodText = `${getMonthName(month)}/${year}`;
                
            } else {
                // Filtro por ano inteiro
                startStr = `${year}-01-01`;
                endStr = `${year}-12-31`;
                periodText = `Ano ${year}`;
            }

            const reportData = [];
            let totalServicos = 0;
            let totalProdutos = 0;
            let totalAssinaturas = 0;
            let countServicos = 0;
            let countProdutos = 0;
            let countAssinaturas = 0;

            // 1. Filtrar Agendamentos (Compara√ß√£o de String √© mais segura para datas ISO)
            if (agendamentosData && Array.isArray(agendamentosData)) {
                agendamentosData.forEach(agendamento => {
                    // Verifica se est√° conclu√≠do E se a data est√° dentro do range
                    if (agendamento.status === 'completed' && agendamento.data) {
                        if (agendamento.data >= startStr && agendamento.data <= endStr) {
                            reportData.push({
                                data: agendamento.data,
                                tipo: 'Servi√ßo',
                                cliente: agendamento.nome || agendamento.cliente || 'Cliente n√£o informado',
                                descricao: agendamento.servico || 'Servi√ßo por assinatura',
                                valor: Number(agendamento.preco || 0)
                            });
                            totalServicos += Number(agendamento.preco || 0);
                            countServicos++;
                        }
                    }
                });
            }

            // 2. Filtrar Vendas de Produtos
            if (entradasData && Array.isArray(entradasData)) {
                entradasData.forEach(entrada => {
                    if (entrada.data) {
                        if (entrada.data >= startStr && entrada.data <= endStr) {
                            reportData.push({
                                data: entrada.data,
                                tipo: 'Produto',
                                cliente: 'Venda Balc√£o',
                                descricao: entrada.descricao || entrada.category || 'Produto',
                                valor: Number(entrada.valor || 0)
                            });
                            totalProdutos += Number(entrada.valor || 0);
                            countProdutos++;
                        }
                    }
                });
            }

            // 3. ADICIONADO: Filtrar Assinaturas Pagas
            if (subscriptionsData && Array.isArray(subscriptionsData)) {
                subscriptionsData.forEach(sub => {
                    if (sub.paymentStatus === 'paid' && sub.lastPaymentDate) {
                        if (sub.lastPaymentDate >= startStr && sub.lastPaymentDate <= endStr) {
                            reportData.push({
                                data: sub.lastPaymentDate,
                                tipo: 'Assinatura',
                                cliente: sub.client || 'Cliente n√£o informado',
                                descricao: sub.planName || 'Assinatura',
                                valor: Number(sub.value || 0)
                            });
                            totalAssinaturas += Number(sub.value || 0);
                            countAssinaturas++;
                        }
                    }
                });
            }

            // Ordenar por data
            reportData.sort((a, b) => {
                if(a.data === b.data) return 0;
                return a.data < b.data ? -1 : 1;
            });

            // Renderizar tabela
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = '';

            if (reportData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem;">
                            Nenhum registro encontrado para o per√≠odo ${periodText}.<br>
                            (Verifique se os agendamentos est√£o marcados como "Conclu√≠do")
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = reportData.map(item => {
                    return `
                    <tr>
                        <td style="font-size:0.9rem;">${item.data.split('-').reverse().join('/')}</td>
                        <td style="font-size:0.9rem;"><span style="color: ${item.tipo === 'Servi√ßo' ? 'var(--primary)' : (item.tipo === 'Produto' ? 'var(--success)' : '#8b5cf6')}">${item.tipo}</span></td>
                        <td style="font-size:0.9rem;">${item.cliente}</td>
                        <td style="font-size:0.9rem;">${item.descricao}</td>
                        <td style="color: var(--primary); font-weight: bold; font-size:0.9rem;">R$ ${item.valor.toFixed(2)}</td>
                    </tr>
                    `;
                }).join('');
            }

            // Calcular total e atualizar tela
            const total = totalServicos + totalProdutos + totalAssinaturas;
            document.getElementById('report-total').innerText = `Total do per√≠odo: R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('report-summary').innerText = `${countServicos} servi√ßos + ${countProdutos} produtos + ${countAssinaturas} assinaturas`;
            document.getElementById('report-period-info').innerText = `Per√≠odo: ${periodText}`;

            document.getElementById('report-results').style.display = 'block';

            // Armazenar para exporta√ß√£o
            window.currentFiscalReportData = {
                data: reportData,
                period: periodText,
                total: total,
                summary: `${countServicos} servi√ßos + ${countProdutos} produtos + ${countAssinaturas} assinaturas`
            };
            
            showToast('Relat√≥rio gerado com sucesso!', 'success');
        };

        // FUN√á√ÉO PARA EXPORTAR RELAT√ìRIO FISCAL
        window.exportFiscalReport = () => {
            if (!fiscalReportEnabled) {
                showToast('‚ùå Relat√≥rio fiscal est√° desabilitado. Converse com o administrador.', 'error');
                return;
            }
            if (!window.currentFiscalReportData || window.currentFiscalReportData.data.length === 0) {
                showToast('Nenhum dado para exportar.', 'warning');
                return;
            }

            const { data, period, total, summary } = window.currentFiscalReportData;
            
            // Cabe√ßalho do CSV
            let csvContent = `Relat√≥rio Fiscal - ${period}\n`;
            csvContent += `Gerado em: ${new Date().toLocaleDateString('pt-BR')}\n`;
            csvContent += `Total: R$ ${total.toFixed(2)} (${summary})\n\n`;
            
            // Cabe√ßalhos das colunas
            csvContent += 'Data,Tipo,Cliente,Descri√ß√£o,Valor\n';
            
            // Dados
            data.forEach(item => {
                csvContent += `${item.data},${item.tipo},"${item.cliente}","${item.descricao}",${item.valor.toFixed(2)}\n`;
            });

            // Criar e baixar arquivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio-fiscal-${period.replace(/[\/ ]/g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Relat√≥rio exportado com sucesso!', 'success');
        };

        // FUN√á√ÉO AUXILIAR PARA OBTER NOME DO M√äS
        function getMonthName(monthNumber) {
            const months = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[parseInt(monthNumber) - 1] || '';
        }

        // === NOVAS FUN√á√ïES PARA CONFIGURA√á√ïES ===
        
        // Salvar informa√ß√µes da barbearia
        async function salvarInformacoesBarbearia() {
            // Verificar se o usu√°rio tem permiss√£o
            if (currentUserEmail !== 'saullinho2008@gmail.com') {
                showToast('Acesso negado: apenas o administrador pode modificar configura√ß√µes.', 'error');
                return;
            }
            
            try {
                const configData = {
                    barberName: document.getElementById('barbearia-nome').value.trim(),
                    barberPhone: document.getElementById('barbearia-telefone').value.trim(),
                    barberAddress: document.getElementById('barbearia-endereco').value.trim(),
                    barberMapsLink: document.getElementById('barbearia-maps-link').value.trim(),
                    updatedAt: new Date(),
                    updatedBy: auth.currentUser?.uid || 'admin'
                };
                
                // Validar campos obrigat√≥rios
                if (!configData.barberName) {
                    showToast("‚ùå Nome da barbearia √© obrigat√≥rio!", "error");
                    return;
                }
                
                console.log('Salvando informa√ß√µes da barbearia:', configData);
                await setDoc(doc(db, "configuracoes_gerais", "barbearia"), configData, { merge: true });
                
                showToast("‚úÖ Informa√ß√µes da barbearia salvas com sucesso!", "success");
                
                // Atualizar apenas o nome da barbearia no header (sem substituir a estrutura)
                const logoEl = document.querySelector('.header-title .logo');
                if (logoEl) {
                    logoEl.textContent = configData.barberName;
                }
                // Atualizar vari√°vel global usada em mensagens
                window.barberName = configData.barberName || window.barberName;
                
            } catch (error) {
                console.error("Erro ao salvar informa√ß√µes da barbearia:", error);
                showToast("‚ùå Erro ao salvar informa√ß√µes: " + error.message, "error");
            }
        }   
        
        // Definir valores padr√£o
        function setarValoresPadrao() {
            document.getElementById('barbearia-nome').value = 'FLOW BARBER';
            document.getElementById('barbearia-telefone').value = '5528999082741';
            document.getElementById('barbearia-endereco').value = 'Av. Central, 149-21 - Alto Lagoa Funda, Marata√≠zes - ES, 29345-000';
            document.getElementById('barbearia-maps-link').value = 'https://maps.app.goo.gl/tMqWDAU2Eh14hp9bA';
        }
        
        // Renderizar configura√ß√£o de hor√°rios
        function renderHorariosConfig() {
            const container = document.getElementById('horarios-config');
            if (!container) return;
            
            const diasSemana = [
                { id: 'domingo', nome: 'Domingo', abre: false },
                { id: 'segunda', nome: 'Segunda-feira', abre: true },
                { id: 'terca', nome: 'Ter√ßa-feira', abre: true },
                { id: 'quarta', nome: 'Quarta-feira', abre: true },
                { id: 'quinta', nome: 'Quinta-feira', abre: true },
                { id: 'sexta', nome: 'Sexta-feira', abre: true },
                { id: 'sabado', nome: 'S√°bado', abre: true }
            ];
            
            container.innerHTML = diasSemana.map(dia => `
                <div class="admin-section" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; position: relative;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; justify-content: space-between;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: bold;">
                            <input type="checkbox" id="abre-${dia.id}" ${dia.abre ? 'checked' : ''}>
                            ${dia.nome}
                        </label>
                        <span id="status-${dia.id}" style="font-size: 0.8rem; color: var(--text-muted); display: none;">‚úÖ Salvo</span>
                    </div>
                    
                    <div id="horarios-${dia.id}" style="${dia.abre ? '' : 'display: none;'}">
                        <div class="form-row" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div>
                                <label>Abertura</label>
                                <input type="time" id="abertura-${dia.id}" value="09:00" class="horario-input">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" id="fechamento-${dia.id}" value="18:00" class="horario-input">
                            </div>
                            <div>
                                <label>Almo√ßo (in√≠cio)</label>
                                <input type="time" id="almoco-inicio-${dia.id}" value="12:00" class="horario-input">
                            </div>
                            <div>
                                <label>Almo√ßo (fim)</label>
                                <input type="time" id="almoco-fim-${dia.id}" value="13:00" class="horario-input">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Adicionar event listeners para auto-save
            diasSemana.forEach(dia => {
                const checkbox = document.getElementById(`abre-${dia.id}`);
                const horariosDiv = document.getElementById(`horarios-${dia.id}`);
                const abertura = document.getElementById(`abertura-${dia.id}`);
                const fechamento = document.getElementById(`fechamento-${dia.id}`);
                const almocoInicio = document.getElementById(`almoco-inicio-${dia.id}`);
                const almocoFim = document.getElementById(`almoco-fim-${dia.id}`);
                
                // Auto-save ao mudar o checkbox
                checkbox.addEventListener('change', () => {
                    horariosDiv.style.display = checkbox.checked ? 'block' : 'none';
                    salvarHorariosFuncionamento(dia.id);
                });
                
                // Auto-save ao mudar os hor√°rios
                const inputs = [abertura, fechamento, almocoInicio, almocoFim];
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        salvarHorariosFuncionamento(dia.id);
                    });
                });
            });
        }
        
        // Salvar hor√°rios de funcionamento (com auto-save)
        async function salvarHorariosFuncionamento(diaParaMostrarStatus = null) {
    // Verificar se o usu√°rio tem permiss√£o
    if (currentUserEmail !== 'saullinho2008@gmail.com') {
        showToast('Acesso negado: apenas o administrador pode modificar configura√ß√µes.', 'error');
        return;
    }
    
    try {
        const horariosData = {};
        const diasSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
        
        diasSemana.forEach(dia => {
            const abre = document.getElementById(`abre-${dia}`)?.checked;
            const abertura = document.getElementById(`abertura-${dia}`)?.value;
            const fechamento = document.getElementById(`fechamento-${dia}`)?.value;
            const almocoInicio = document.getElementById(`almoco-inicio-${dia}`)?.value;
            const almocoFim = document.getElementById(`almoco-fim-${dia}`)?.value;
            
            horariosData[dia] = {
                abre: abre,
                abertura: abertura,
                fechamento: fechamento,
                almocoInicio: almocoInicio,
                almocoFim: almocoFim
            };
        });
        
        console.log('Salvando hor√°rios:', horariosData);
        await setDoc(doc(db, "configuracoes_gerais", "horarios"), {
            ...horariosData,
            updatedAt: new Date(),
            updatedBy: auth.currentUser?.uid || 'admin'
        });
        
        // Salvar globalmente e atualizar slots
        window.horariosConfig = horariosData;
        
        // Mostrar status de salvo no dia espec√≠fico
        if (diaParaMostrarStatus) {
            const statusEl = document.getElementById(`status-${diaParaMostrarStatus}`);
            if (statusEl) {
                statusEl.style.display = 'inline';
                statusEl.style.color = 'var(--success)';
                statusEl.textContent = '‚úÖ Salvo';
                
                // Esconder o status ap√≥s 2 segundos
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 2000);
            }
        } else {
            // Se for salvar tudo, mostrar toast
            showToast("‚úÖ Hor√°rios salvos com sucesso!", "success");
        }
        
        // Atualizar slots se estiver na aba de agendamentos
        if (document.getElementById('tab-agendamentos')?.classList.contains('active')) {
            renderSlots();
        }
        
    } catch (error) {
        console.error("Erro ao salvar hor√°rios:", error);
        showToast("‚ùå Erro ao salvar hor√°rios: " + error.message, "error");
    }
}
        
        // Carregar hor√°rios salvos
        async function loadHorariosFuncionamento() {
    try {
        const docRef = doc(db, "configuracoes_gerais", "horarios");
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const horarios = docSnap.data();
            console.log('=== HOR√ÅRIOS CARREGADOS DO FIREBASE ===');
            console.log(horarios);
            
            // Salvar globalmente para usar em renderSlots
            window.horariosConfig = horarios;
            
            const diasSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
            
            diasSemana.forEach(dia => {
                const diaData = horarios[dia];
                if (diaData) {
                    console.log(`${dia}: abre=${diaData.abre}, abertura=${diaData.abertura}, fechamento=${diaData.fechamento}`);
                    
                    const checkbox = document.getElementById(`abre-${dia}`);
                    const abertura = document.getElementById(`abertura-${dia}`);
                    const fechamento = document.getElementById(`fechamento-${dia}`);
                    const almocoInicio = document.getElementById(`almoco-inicio-${dia}`);
                    const almocoFim = document.getElementById(`almoco-fim-${dia}`);
                    
                    if (checkbox) checkbox.checked = diaData.abre !== false;
                    if (abertura) abertura.value = diaData.abertura || '09:00';
                    if (fechamento) fechamento.value = diaData.fechamento || '18:00';
                    if (almocoInicio) almocoInicio.value = diaData.almocoInicio || '12:00';
                    if (almocoFim) almocoFim.value = diaData.almocoFim || '13:00';
                    
                    // Atualizar visibilidade dos hor√°rios
                    const horariosDiv = document.getElementById(`horarios-${dia}`);
                    if (horariosDiv) {
                        horariosDiv.style.display = diaData.abre !== false ? 'block' : 'none';
                    }
                }
            });
            
            // Atualizar a agenda se estiver na aba de agendamentos
            if (document.getElementById('tab-agendamentos').classList.contains('active')) {
                renderSlots();
            }
        } else {
            console.log('Nenhuma configura√ß√£o de hor√°rios encontrada no Firebase');
            // Se n√£o houver configura√ß√µes, usar padr√µes
            window.horariosConfig = {
                domingo: { abre: false, abertura: '09:00', fechamento: '18:00', almocoInicio: '12:00', almocoFim: '13:00' },
                segunda: { abre: true, abertura: '09:00', fechamento: '18:00', almocoInicio: '12:00', almocoFim: '13:00' },
                terca: { abre: true, abertura: '09:00', fechamento: '18:00', almocoInicio: '12:00', almocoFim: '13:00' },
                quarta: { abre: true, abertura: '09:00', fechamento: '18:00', almocoInicio: '12:00', almocoFim: '13:00' },
                quinta: { abre: true, abertura: '09:00', fechamento: '18:00', almocoInicio: '12:00', almocoFim: '13:00' },
                sexta: { abre: true, abertura: '09:00', fechamento: '18:00', almocoInicio: '12:00', almocoFim: '13:00' },
                sabado: { abre: true, abertura: '09:00', fechamento: '18:00', almocoInicio: '12:00', almocoFim: '13:00' }
            };
        }
    } catch (error) {
        console.error("Erro ao carregar hor√°rios:", error);
    }
}
        
        // Atualizar fun√ß√£o loadConfiguracoesGerais para incluir informa√ß√µes da barbearia
        async function loadConfiguracoesGerais() {
            try {
                console.log('Carregando configura√ß√µes gerais...');
                const docRef = doc(db, "configuracoes_gerais", "barbearia");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    console.log('Configura√ß√µes encontradas:', config);
                    
                    // Salvar nome globalmente para mensagens WhatsApp
                    window.barberName = config.barberName || 'FLOW BARBER';
                    
                    // Preencher campos de informa√ß√µes da barbearia
                    const nomeField = document.getElementById('barbearia-nome');
                    const telefoneField = document.getElementById('barbearia-telefone');
                    const enderecoField = document.getElementById('barbearia-endereco');
                    const mapsField = document.getElementById('barbearia-maps-link');
                    
                    if (nomeField) nomeField.value = config.barberName || '';
                    if (telefoneField) telefoneField.value = config.barberPhone || '';
                    if (enderecoField) enderecoField.value = config.barberAddress || '';
                    if (mapsField) mapsField.value = config.barberMapsLink || '';
                    
                    // Atualizar apenas o nome da barbearia no header (sem substituir a estrutura)
                    const logoEl = document.querySelector('.header-title .logo');
                    if (logoEl && config.barberName) {
                        logoEl.textContent = config.barberName;
                    }
                    // Atualizar vari√°vel global usada em mensagens
                    window.barberName = config.barberName || window.barberName;
                } else {
                    console.log('Nenhuma configura√ß√£o no Firebase, usando padr√µes');
                    setarValoresPadrao();
                }
            } catch (error) {
                console.error("Erro ao carregar configura√ß√µes:", error);
                setarValoresPadrao();
            }
        } // Fecha a fun√ß√£o loadConfiguracoesGerais
        
        // Setup listener em tempo real para atualizar barberName nas mensagens WhatsApp
        function setupBarbeariaListener() {
            const docRef = doc(db, "configuracoes_gerais", "barbearia");
            onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    const config = snapshot.data();
                    window.barberName = config.barberName || 'FLOW BARBER';
                    console.log('Nome da barbearia atualizado para:', window.barberName);
                }
            });
        }
        
        // === FUN√á√ïES PARA DURA√á√ÉO DE AGENDAMENTOS ===
        
        async function salvarDuracaoAgendamento() {
    // Verificar se o usu√°rio tem permiss√£o
    if (currentUserEmail !== 'saullinho2008@gmail.com') {
        showToast('Acesso negado: apenas o administrador pode modificar configura√ß√µes.', 'error');
        return;
    }
    
    try {
        const duracao = document.getElementById('duracao-agendamento').value;
        
        if (!duracao) {
            showToast("‚ùå Selecione uma dura√ß√£o v√°lida!", "error");
            return;
        }
        
        console.log('Salvando dura√ß√£o de agendamento:', duracao);
        await setDoc(doc(db, "configuracoes_gerais", "agendamentos"), {
            duracao: parseInt(duracao),
            updatedAt: new Date(),
            updatedBy: auth.currentUser?.uid || 'admin'
        }, { merge: true });
        
        // Atualizar globalmente
        window.duracaoAgendamento = parseInt(duracao);
        
        // Recarregar os hor√°rios dispon√≠veis com a nova dura√ß√£o
        if (document.getElementById('tab-agendamentos').classList.contains('active')) {
            renderSlots();
        }
        
        showToast("‚úÖ Dura√ß√£o de agendamentos salva com sucesso!", "success");
        
    } catch (error) {
        console.error("Erro ao salvar dura√ß√£o de agendamento:", error);
        showToast("‚ùå Erro ao salvar dura√ß√£o: " + error.message, "error");
    }
}
        
        async function loadDuracaoAgendamento() {
    try {
        const docRef = doc(db, "configuracoes_gerais", "agendamentos");
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const dados = docSnap.data();
            const duracao = dados.duracao || 30;
            
            const selectDuracao = document.getElementById('duracao-agendamento');
            if (selectDuracao) {
                selectDuracao.value = duracao.toString();
            }
            
            // Armazenar globalmente para usar em renderiza√ß√µes
            window.duracaoAgendamento = duracao;
            
            console.log('Dura√ß√£o de agendamento carregada:', duracao);
        } else {
            // Valor padr√£o
            window.duracaoAgendamento = 30;
        }
    } catch (error) {
        console.error("Erro ao carregar dura√ß√£o de agendamento:", error);
        window.duracaoAgendamento = 30; // Usar padr√£o se houver erro
    }
}
        
        // Vari√°vel global para status de assinaturas
        let subscriptionsEnabled = true;
        
        // Carregar status de assinaturas
        async function loadSubscriptionsStatus() {
            try {
                const docRef = doc(db, "configuracoes_gerais", "assinaturas");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    subscriptionsEnabled = dados.enabled !== false;
                } else {
                    subscriptionsEnabled = true;
                }
                
                updateSubscriptionsStatusUI();
            } catch (error) {
                console.error("Erro ao carregar status de assinaturas:", error);
                subscriptionsEnabled = true;
            }
        }
        
        // Atualizar UI de status de assinaturas
        function updateSubscriptionsStatusUI() {
            const statusText = document.getElementById('subscriptions-status');
            const enableBtn = document.getElementById('btn-enable-subscriptions');
            const disableBtn = document.getElementById('btn-disable-subscriptions');
            const menuItem = document.getElementById('assinaturas-menu-item');
            
            if (subscriptionsEnabled) {
                if (statusText) statusText.innerHTML = '‚úÖ <strong>ATIVADO</strong> - Sistema de assinaturas est√° funcionando';
                if (enableBtn) enableBtn.style.opacity = '1';
                if (disableBtn) disableBtn.style.opacity = '0.5';
                if (menuItem) menuItem.style.display = '';
            } else {
                if (statusText) statusText.innerHTML = '‚ùå <strong>DESATIVADO</strong> - Sistema de assinaturas est√° desligado';
                if (enableBtn) enableBtn.style.opacity = '0.5';
                if (disableBtn) disableBtn.style.opacity = '1';
                if (menuItem) menuItem.style.display = 'none';
                // If currently viewing the subscriptions tab, switch to dashboard
                if (document.getElementById('tab-assinaturas') && document.getElementById('tab-assinaturas').classList.contains('active')) {
                    switchTab('dashboard');
                }
            }
        }
        
        // Toggle assinaturas
        window.toggleSubscriptionsEnabled = async (enabled) => {
            // Verificar permiss√£o
            if (currentUserEmail !== 'saullinho2008@gmail.com') {
                showToast('Acesso negado: apenas o administrador pode modificar configura√ß√µes.', 'error');
                return;
            }
            
            try {
                subscriptionsEnabled = enabled;
                
                await setDoc(doc(db, "configuracoes_gerais", "assinaturas"), {
                    enabled: enabled,
                    updatedAt: new Date(),
                    updatedBy: auth.currentUser?.uid || 'admin'
                }, { merge: true });
                
                updateSubscriptionsStatusUI();
                showToast(enabled ? '‚úÖ Assinaturas ativadas!' : '‚ùå Assinaturas desativadas!', 'success');
            } catch (error) {
                console.error("Erro ao atualizar status de assinaturas:", error);
                showToast("‚ùå Erro ao atualizar: " + error.message, "error");
            }
        };
        
        // Vari√°vel global para status de relat√≥rio fiscal
        let fiscalReportEnabled = false;
        
        // Carregar status de relat√≥rio fiscal
        async function loadFiscalReportStatus() {
            try {
                const docRef = doc(db, "configuracoes_gerais", "fiscal_report");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    fiscalReportEnabled = dados.enabled === true;
                } else {
                    fiscalReportEnabled = false;
                }
                
                updateFiscalReportStatusUI();
            } catch (error) {
                console.error("Erro ao carregar status de relat√≥rio fiscal:", error);
                fiscalReportEnabled = false;
            }
        }
        
        // Atualizar UI de status de relat√≥rio fiscal
        function updateFiscalReportStatusUI() {
            const statusText = document.getElementById('fiscal-report-status');
            const enableBtn = document.getElementById('btn-enable-fiscal-report');
            const disableBtn = document.getElementById('btn-disable-fiscal-report');
            
            if (fiscalReportEnabled) {
                if (statusText) statusText.innerHTML = '‚úÖ <strong>ATIVADO</strong> - Relat√≥rio fiscal est√° dispon√≠vel';
                if (enableBtn) enableBtn.style.opacity = '0.5';
                if (disableBtn) disableBtn.style.opacity = '1';
            } else {
                if (statusText) statusText.innerHTML = '‚ùå <strong>DESATIVADO</strong> - Converse com o Admin para alterar para um plano que tenha esse recurso';
                if (enableBtn) enableBtn.style.opacity = '1';
                if (disableBtn) disableBtn.style.opacity = '0.5';
            }
        }
        
        // Toggle relat√≥rio fiscal
        window.toggleFiscalReport = async (enabled) => {
            // Verificar permiss√£o
            if (currentUserEmail !== 'saullinho2008@gmail.com') {
                showToast('Acesso negado: apenas o administrador pode modificar configura√ß√µes.', 'error');
                return;
            }
            
            try {
                fiscalReportEnabled = enabled;
                
                const configRef = doc(db, "configuracoes_gerais", "fiscal_report");
                await setDoc(configRef, {
                    enabled: enabled,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser?.email || 'admin'
                });
                
                updateFiscalReportStatusUI();
                showToast(enabled ? '‚úÖ Relat√≥rio fiscal ativado!' : '‚ùå Relat√≥rio fiscal desativado!', 'success');
                console.log('Status do relat√≥rio fiscal atualizado para:', enabled);
            } catch (error) {
                console.error("Erro ao atualizar status de relat√≥rio fiscal:", error);
                showToast("‚ùå Erro ao atualizar: " + error.message, "error");
                // Recarregar status anterior
                loadFiscalReportStatus();
            }
        };
        window.salvarInformacoesBarbearia = salvarInformacoesBarbearia;
        window.renderHorariosConfig = renderHorariosConfig;
        window.salvarHorariosFuncionamento = salvarHorariosFuncionamento;
        window.loadHorariosFuncionamento = loadHorariosFuncionamento;
        window.salvarDuracaoAgendamento = salvarDuracaoAgendamento;
        window.loadDuracaoAgendamento = loadDuracaoAgendamento;
        window.loadSubscriptionsStatus = loadSubscriptionsStatus;
        window.loadConfiguracoesGerais = loadConfiguracoesGerais;
        window.setupBarbeariaListener = setupBarbeariaListener;
        window.setarValoresPadrao = setarValoresPadrao;
        window.ensureServicesLoaded = ensureServicesLoaded;
        window.ensureDataSync = ensureDataSync;
        
        // Inicializar configura√ß√µes ao carregar p√°gina
        console.log('=== Script admin.html carregado ===');
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOMContentLoaded - Carregando configura√ß√µes...');
                setTimeout(() => {
                    loadConfiguracoesGerais();
                    setupBarbeariaListener();
                    renderHorariosConfig();
                    loadHorariosFuncionamento();
                    loadDuracaoAgendamento();
                    loadSubscriptionsStatus();
                    loadFiscalReportStatus();
                }, 300);
            });
        } else {
            console.log('DOM j√° pronto - Carregando configura√ß√µes imediatamente...');
            loadConfiguracoesGerais();
            setupBarbeariaListener();
            renderHorariosConfig();
            loadHorariosFuncionamento();
            loadDuracaoAgendamento();
            loadSubscriptionsStatus();
            loadFiscalReportStatus();
        }
        
        // Adicionar evento para atualizar o select de servi√ßos quando abrir a aba de agendamentos
        document.addEventListener('DOMContentLoaded', function() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (document.getElementById('tab-agendamentos').classList.contains('active')) {
                            populateServiceSelect();
                        }
                    }
                });
            });
            
            // Observar mudan√ßas na aba de agendamentos
            const agendaTab = document.getElementById('tab-agendamentos');
            if (agendaTab) {
                observer.observe(agendaTab, { attributes: true });
            }
            
        });

        function generateTimeSlots(startTime, endTime, lunchStart, lunchEnd) {
    const slots = [];
    
    // Converter para minutos desde meia-noite
    function timeToMinutes(time) {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
    }
    
    // Converter minutos para string de tempo
    function minutesToTime(minutes) {
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }
    
    const startMinutes = timeToMinutes(startTime);
    const endMinutes = timeToMinutes(endTime);
    const lunchStartMinutes = timeToMinutes(lunchStart);
    const lunchEndMinutes = timeToMinutes(lunchEnd);
    
    // Dura√ß√£o de cada slot (30 minutos por padr√£o)
    const slotDuration = window.duracaoAgendamento || 30;
    
    // Gerar slots
    for (let time = startMinutes; time < endMinutes; time += slotDuration) {
        // Pular hor√°rio de almo√ßo
        if (time >= lunchStartMinutes && time < lunchEndMinutes) {
            continue;
        }
        
        slots.push(minutesToTime(time));
    }
    
    return slots;
}

        // Fun√ß√£o para garantir sincroniza√ß√£o de todos os dados
        function ensureDataSync() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 30; // ~9 segundos (30 * 300ms)
                
                const checkData = () => {
                    attempts++;
                    
                    // Verificar se temos dados carregados
                    const hasAgendamentos = Array.isArray(agendamentosData) && agendamentosData.length > 0;
                    const hasSubscriptions = Array.isArray(subscriptionsData);
                    const hasExpenses = Array.isArray(despesasData);
                    const hasEntries = Array.isArray(entradasData);
                    const hasServices = Array.isArray(servicesData) && servicesData.length > 0;
                    
                    // Se temos todos os dados principais carregados
                    const allChecked = hasAgendamentos && hasSubscriptions && hasExpenses && hasEntries && hasServices;
                    const isComplete = allChecked || attempts >= maxAttempts;
                    
                    if (isComplete) {
                        console.log('‚úÖ Dados sincronizados (tentativa ' + attempts + '):', {
                            agendamentos: agendamentosData.length,
                            subscriptions: subscriptionsData.length,
                            expenses: despesasData.length,
                            entries: entradasData.length,
                            services: servicesData.length,
                            allDataLoaded: allChecked
                        });
                        isFirstLoadComplete = true;
                        resolve();
                    } else {
                        if (attempts % 5 === 0) {
                            console.log(`‚è≥ Aguardando sincroniza√ß√£o (${attempts}/${maxAttempts})...`);
                        }
                        setTimeout(checkData, 300);
                    }
                };
                checkData();
            });
        }

        function ensureServicesLoaded() {
            // Verificar se servicesData est√° carregado ap√≥s 2 segundos
            setTimeout(() => {
                if (!servicesData || servicesData.length === 0) {
                    console.log('ServicesData ainda vazio ap√≥s 2s, tentando recarregar...');
                    
                    
                    // Tentar for√ßar recarregamento
                    const servicesRef = collection(db, "services");
                    getDocs(servicesRef).then(snap => {
                        servicesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        console.log('Servi√ßos recarregados manualmente:', servicesData.length);
                        
                        // Se ainda vazio, criar servi√ßos padr√£o
                        if (servicesData.length === 0) {
                            console.log('Servi√ßos ainda vazios, criando padr√µes...');
                            // Chama o listener que criar√° os padr√µes
                        } else {
                            // Atualizar interfaces
                            renderServices();
                            populateServiceSelect();
                        }
                    }).catch(err => {
                        console.error('Erro ao recarregar servi√ßos:', err);
                    });
                } else {
                    console.log('ServicesData carregado corretamente:', servicesData.length, 'itens');
                }
            }, 2000);
        }
    



        if ("serviceWorker" in navigator && window.location.protocol !== 'file:') {
          navigator.serviceWorker.register("/service-worker.js").catch(err => {
            console.warn('Erro ao registrar service-worker.js:', err.message);
          });
          navigator.serviceWorker.register("/firebase-messaging-sw.js").catch(err => {
            console.warn('Erro ao registrar firebase-messaging-sw.js:', err.message);
          });
        }

const messaging = getMessaging(app);
// `auth` and `db` were already initialized earlier in this module ‚Äî don't redeclare them.
// `currentUserEmail` was defined earlier; avoid redeclaration here.

async function enableNotifications() {
  try {
    // Verificar se est√° rodando em um protocolo seguro (n√£o local file://)
    if (window.location.protocol === 'file:') {
      console.warn('ServiceWorker n√£o pode ser registrado em arquivo local (file://). Use um servidor HTTP.');
      return;
    }

    const permission = await Notification.requestPermission();
    if (permission !== "granted") return;

    // Registra o Service Worker
    await navigator.serviceWorker.register("/firebase-messaging-sw.js");
    const registration = await navigator.serviceWorker.ready;

    // Gera o token FCM
    const token = await getToken(messaging, {
      vapidKey: "BFCyx38SAwPFbLIIErfFmaJlk1TksQ_6MAxwBfSAyyQ4-DmH5btXX5RZ0bjO_RmhcWzcYWnD7rsjBaFd1QjL1no",
      serviceWorkerRegistration: registration
    });

    console.log("FCM TOKEN:", token);

    // üî• Salva sem sobrescrever (suporta v√°rios dispositivos) ‚Äî registra email+token como pedido
    if (token && currentUserEmail) {
      await addDoc(
        collection(db, "barbeirosTokens"),
        {
          email: currentUserEmail,
          token,
          createdAt: serverTimestamp()
        }
      );
    }
  } catch (error) {
    console.warn('Erro ao configurar notifica√ß√µes:', error.message);
    // N√£o impede o funcionamento do app se houver erro de notifica√ß√µes
  }
}

// Ativa notifica√ß√µes quando o barbeiro logar
onAuthStateChanged(auth, user => {
  if (user) {
    currentUserEmail = user.email;
    enableNotifications();
  }
});



    </script>
</body>
</html>